name: Build & Commit PDFs (Never Fail)

on:
  push:
    branches: [main]
    paths:
      - "content/**"
      - "scripts/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - ".github/workflows/pdfs.yml"
  workflow_dispatch: {}
  schedule:
    # Run daily at 2 AM UTC to catch any missed generations
    - cron: '0 2 * * *'

permissions:
  contents: write

concurrency:
  group: pdfs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pdfs:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    
    env:
      NODE_ENV: production
      NEXT_TELEMETRY_DISABLED: "1"
      PDF_ON_CI: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      # Install system dependencies for PDF generation
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-plain-generic \
            fonts-liberation \
            libvips-dev
          echo "‚úÖ System dependencies installed"

      - name: Install Node dependencies
        run: |
          pnpm install --frozen-lockfile=false
          # Install additional PDF generation packages
          pnpm add -D pdf-lib sharp markdown-pdf
          echo "‚úÖ Node dependencies installed"

      - name: Ensure required directories exist
        run: |
          mkdir -p public/assets/downloads
          mkdir -p public/assets/resources/pdfs
          mkdir -p public/assets/images/canon
          mkdir -p public/assets/images/downloads
          mkdir -p public/assets/images/resources
          echo "‚úÖ All directories created"

      - name: Generate PDFs with error recovery
        id: generate_pdfs
        continue-on-error: true
        run: |
          echo "üöÄ Starting PDF generation..."
          pnpm run pdfs 2>&1 | tee pdf-generation.log
          
          # Check if any PDFs were generated
          PDF_COUNT=$(find public/assets/downloads public/assets/resources/pdfs -name "*.pdf" 2>/dev/null | wc -l)
          echo "Generated or found $PDF_COUNT PDFs"
          echo "pdf_count=$PDF_COUNT" >> $GITHUB_OUTPUT
          
          # Always succeed even if some PDFs failed
          exit 0

      - name: Validate downloads manifest
        id: validate
        continue-on-error: true
        run: |
          echo "üìä Validating downloads manifest..."
          pnpm run downloads:validate 2>&1 | tee validation.log || true
          
          # Count validation errors
          ERROR_COUNT=$(grep -c "‚ùå" validation.log || echo "0")
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
          
          # Always succeed to allow commit
          exit 0

      - name: Create generation report
        run: |
          cat > GENERATION_REPORT.md << 'EOF'
          # PDF Generation Report
          
          **Run Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          
          ## Summary
          - PDFs Found: ${{ steps.generate_pdfs.outputs.pdf_count }}
          - Validation Errors: ${{ steps.validate.outputs.error_count }}
          
          ## Generation Log
          ```
          $(cat pdf-generation.log)
          ```
          
          ## Validation Log
          ```
          $(cat validation.log)
          ```
          EOF
          
          echo "üìÑ Generation report created"

      - name: Check for changes
        id: check_changes
        run: |
          git add -A
          
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected"
            git diff --cached --stat
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Commit with detailed message
          cat > commit_message.txt << 'EOF'
          chore(assets): auto-generate missing PDFs and images [skip ci]
          
          Generated/Updated:
          - PDFs: ${{ steps.generate_pdfs.outputs.pdf_count }} found
          - Validation errors: ${{ steps.validate.outputs.error_count }}
          
          See GENERATION_REPORT.md for details.
          EOF
          
          git commit -F commit_message.txt || echo "Nothing to commit"
          
          # Push with retry logic
          for i in {1..3}; do
            if git push; then
              echo "‚úÖ Successfully pushed changes"
              break
            else
              echo "‚ö†Ô∏è  Push failed, attempt $i/3"
              sleep 5
              git pull --rebase
            fi
          done

      - name: Upload generation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pdf-generation-report-${{ github.run_number }}
          path: |
            GENERATION_REPORT.md
            pdf-generation.log
            validation.log
          retention-days: 30

      - name: Comment on commit with summary
        if: steps.check_changes.outputs.has_changes == 'true' && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const pdfCount = '${{ steps.generate_pdfs.outputs.pdf_count }}';
            const errorCount = '${{ steps.validate.outputs.error_count }}';
            
            const body = `## üìÑ PDF Generation Summary
            
            - ‚úÖ PDFs processed: ${pdfCount}
            - ${errorCount > 0 ? '‚ö†Ô∏è' : '‚úÖ'} Validation errors: ${errorCount}
            
            ${errorCount > 0 ? '‚ö†Ô∏è Some assets may still need manual creation.' : '‚úÖ All assets validated successfully!'}
            
            View full report in [workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).`;
            
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: body
            });

      - name: Final status
        if: always()
        run: |
          echo "=================================================="
          echo "PDF Generation Workflow Complete"
          echo "=================================================="
          echo "Status: ‚úÖ SUCCESS (workflow never fails)"
          echo "PDFs: ${{ steps.generate_pdfs.outputs.pdf_count }}"
          echo "Errors: ${{ steps.validate.outputs.error_count }}"
          echo "Changes: ${{ steps.check_changes.outputs.has_changes }}"
          echo "=================================================="
          echo ""
          echo "This workflow is designed to NEVER fail."
          echo "Missing assets are created as placeholders."
          echo "Check the generation report for details."
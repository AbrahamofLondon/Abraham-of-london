name: Strategic PDF Generation

on:
  push:
    branches: [main]
    paths:
      - "content/**"
      - "scripts/generate-pdfs.ts"
      - "scripts/generate-standalone-pdf.tsx"
      - "scripts/generate-frameworks-pdf.tsx"
      - "public/assets/images/**"
      - "lib/pdfs/**"
      - "package.json"
      - "pnpm-lock.yaml"
  workflow_dispatch: {}
  schedule:
    - cron: '0 4 * * 0'  # Weekly on Sunday at 4 AM UTC

jobs:
  generate-pdfs:
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: üìö Install dependencies
        run: |
          pnpm install --frozen-lockfile
          echo "‚úÖ Dependencies installed"
          
      - name: üìÅ Clean previous builds
        run: |
          # Clean old generated files to avoid duplication
          rm -rf lib/pdfs/*.pdf 2>/dev/null || true
          rm -rf public/assets/downloads/*.pdf 2>/dev/null || true
          echo "üßπ Cleaned previous PDF builds"
          
      - name: üìÅ Create directories
        run: |
          mkdir -p lib/pdfs
          mkdir -p public/assets/downloads
          mkdir -p public/assets/images
          mkdir -p content
          echo "üìÅ Directory structure created"
          
      - name: üîç Validate configurations
        id: validate
        run: |
          echo "üîç Validating PDF configurations..."
          
          # Check if all registry entries have required fields
          ERROR_COUNT=0
          WARNING_COUNT=0
          
          echo "üìã Checking PDF registry configurations..."
          
          # Use a simpler check to avoid module import issues
          if node -e "
            const fs = require('fs');
            const path = require('path');
            try {
              const scriptPath = path.join(process.cwd(), 'scripts/generate-pdfs.ts');
              const content = fs.readFileSync(scriptPath, 'utf8');
              
              // Look for PDF_REGISTRY definition
              if (!content.includes('PDF_REGISTRY')) {
                console.error('‚ùå PDF_REGISTRY not found in generate-pdfs.ts');
                process.exit(1);
              }
              
              console.log('‚úÖ PDF_REGISTRY configuration found');
            } catch (error) {
              console.error('‚ùå Error reading configuration:', error.message);
              process.exit(1);
            }
          " 2>&1; then
            echo "‚úÖ Configuration validation passed"
            echo "config_valid=true" >> $GITHUB_OUTPUT
          else
            echo "::error::Configuration validation failed"
            echo "config_valid=false" >> $GITHUB_OUTPUT
          fi
          
      - name: üöÄ Generate all PDFs (batch mode)
        id: generate-batch
        if: steps.validate.outputs.config_valid == 'true'
        run: |
          echo "üöÄ Generating premium PDFs (batch mode)..."
          
          # Run batch PDF generation from scripts/generate-pdfs.tsx
          if pnpm run pdfs:all 2>&1 | tee generation.log; then
            echo "‚úÖ Batch PDF generation completed"
            echo "batch_generation_success=true" >> $GITHUB_OUTPUT
          else
            echo "::error::Batch PDF generation failed"
            echo "batch_generation_success=false" >> $GITHUB_OUTPUT
          fi
          
      - name: üöÄ Generate standalone PDF
        id: generate-standalone
        if: steps.validate.outputs.config_valid == 'true'
        run: |
          echo "üöÄ Generating standalone editorial PDF..."
          
          if pnpm run pdfs:standalone 2>&1 | tee -a generation.log; then
            echo "‚úÖ Standalone PDF generation completed"
            echo "standalone_generation_success=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Standalone PDF generation failed or skipped"
            echo "standalone_generation_success=false" >> $GITHUB_OUTPUT
          fi
          
      - name: üöÄ Generate frameworks PDF
        id: generate-frameworks
        if: steps.validate.outputs.config_valid == 'true'
        run: |
          echo "üöÄ Generating frameworks PDF..."
          
          if pnpm run pdfs:frameworks 2>&1 | tee -a generation.log; then
            echo "‚úÖ Frameworks PDF generation completed"
            echo "frameworks_generation_success=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Frameworks PDF generation failed or skipped"
            echo "frameworks_generation_success=false" >> $GITHUB_OUTPUT
          fi
          
      - name: üîç Consolidate and deduplicate PDFs
        id: consolidate
        if: always()
        run: |
          echo "üîç Consolidating PDFs and removing duplicates..."
          
          # Count PDFs in both locations
          LIB_PDFS_COUNT=$(find lib/pdfs -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | wc -l)
          PUBLIC_PDFS_COUNT=$(find public/assets/downloads -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | wc -l)
          
          echo "üìä PDF counts before consolidation:"
          echo "  lib/pdfs/: $LIB_PDFS_COUNT PDF(s)"
          echo "  public/assets/downloads/: $PUBLIC_PDFS_COUNT PDF(s)"
          
          # If both locations have PDFs, prefer lib/pdfs as source of truth
          if [ $LIB_PDFS_COUNT -gt 0 ]; then
            echo "üì¶ Using lib/pdfs as primary source..."
            
            # Copy unique PDFs from lib/pdfs to public/assets/downloads
            for pdf in lib/pdfs/*.pdf; do
              if [ -f "$pdf" ]; then
                filename=$(basename "$pdf")
                # Check if already exists in public folder
                if [ ! -f "public/assets/downloads/$filename" ]; then
                  echo "  Copying: $filename to public folder"
                  cp "$pdf" "public/assets/downloads/"
                else
                  echo "  Skipping: $filename (already exists in public folder)"
                fi
              fi
            done
            
            # Now copy from public/assets/downloads to lib/pdfs for any missing
            for pdf in public/assets/downloads/*.pdf; do
              if [ -f "$pdf" ]; then
                filename=$(basename "$pdf")
                # Check if already exists in lib folder
                if [ ! -f "lib/pdfs/$filename" ]; then
                  echo "  Backfilling: $filename to lib folder"
                  cp "$pdf" "lib/pdfs/"
                fi
              fi
            done
          elif [ $PUBLIC_PDFS_COUNT -gt 0 ]; then
            echo "üì¶ Using public/assets/downloads as primary source..."
            # Copy all PDFs from public to lib
            cp public/assets/downloads/*.pdf lib/pdfs/ 2>/dev/null || true
          fi
          
          # Final counts
          FINAL_LIB_COUNT=$(find lib/pdfs -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | wc -l)
          FINAL_PUBLIC_COUNT=$(find public/assets/downloads -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | wc -l)
          
          echo "üìä Final PDF counts:"
          echo "  lib/pdfs/: $FINAL_LIB_COUNT PDF(s)"
          echo "  public/assets/downloads/: $FINAL_PUBLIC_COUNT PDF(s)"
          
          # List all unique PDFs
          echo "üìã All unique PDF files:"
          find lib/pdfs public/assets/downloads -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | sort | uniq | xargs -I {} basename {}
          
          echo "unique_pdf_count=$(( $FINAL_LIB_COUNT > $FINAL_PUBLIC_COUNT ? $FINAL_LIB_COUNT : $FINAL_PUBLIC_COUNT ))" >> $GITHUB_OUTPUT
          
      - name: üìä Verify generation success
        id: verify-success
        run: |
          echo "üìä Verifying overall generation success..."
          
          # Check if any generation was successful
          BATCH_SUCCESS="${{ steps.generate-batch.outputs.batch_generation_success || 'false' }}"
          STANDALONE_SUCCESS="${{ steps.generate-standalone.outputs.standalone_generation_success || 'false' }}"
          FRAMEWORKS_SUCCESS="${{ steps.generate-frameworks.outputs.frameworks_generation_success || 'false' }}"
          UNIQUE_COUNT="${{ steps.consolidate.outputs.unique_pdf_count || 0 }}"
          
          if [ "$BATCH_SUCCESS" = "true" ] || [ "$STANDALONE_SUCCESS" = "true" ] || [ "$FRAMEWORKS_SUCCESS" = "true" ]; then
            echo "‚úÖ At least one PDF generation succeeded"
            echo "overall_success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå All PDF generations failed"
            echo "overall_success=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if we have a reasonable number of PDFs
          if [ $UNIQUE_COUNT -ge 1 ]; then
            echo "‚úÖ Generated $UNIQUE_COUNT unique PDF(s)"
            echo "sufficient_count=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  No PDFs generated"
            echo "sufficient_count=false" >> $GITHUB_OUTPUT
          fi
          
      - name: üìÑ Check for file changes
        id: check-changes
        if: always()
        run: |
          echo "üìÑ Checking for file changes..."
          
          # Check for changes in both directories
          CHANGED_IN_LIB=$(git status --porcelain lib/pdfs/ 2>/dev/null | wc -l)
          CHANGED_IN_PUBLIC=$(git status --porcelain public/assets/downloads/ 2>/dev/null | wc -l)
          TOTAL_CHANGES=$((CHANGED_IN_LIB + CHANGED_IN_PUBLIC))
          
          if [ $TOTAL_CHANGES -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files=$TOTAL_CHANGES" >> $GITHUB_OUTPUT
            echo "üìù File changes detected:"
            echo "  lib/pdfs/: $CHANGED_IN_LIB file(s)"
            echo "  public/assets/downloads/: $CHANGED_IN_PUBLIC file(s)"
            
            if [ $CHANGED_IN_LIB -gt 0 ]; then
              git status --porcelain lib/pdfs/
            fi
            if [ $CHANGED_IN_PUBLIC -gt 0 ]; then
              git status --porcelain public/assets/downloads/
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No changes detected"
          fi
          
      - name: üì§ Commit generated PDFs
        if: |
          steps.verify-success.outputs.overall_success == 'true' &&
          steps.check-changes.outputs.has_changes == 'true' &&
          steps.verify-success.outputs.sufficient_count == 'true'
        run: |
          echo "üì§ Committing generated PDFs..."
          
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Add PDFs from both locations
          git add lib/pdfs/*.pdf 2>/dev/null || true
          git add public/assets/downloads/*.pdf 2>/dev/null || true
          git add public/assets/downloads/*.json 2>/dev/null || true
          git add public/assets/downloads/*.txt 2>/dev/null || true
          
          if ! git diff --cached --quiet; then
            # Get commit details
            PDF_FILES=$(git diff --cached --name-only | grep '\.pdf$' | wc -l)
            REPORT_FILES=$(git diff --cached --name-only | grep '\.json$\|\.txt$' | wc -l)
            
            LIB_FILES=$(git diff --cached --name-only | grep '^lib/pdfs/' | wc -l)
            PUBLIC_FILES=$(git diff --cached --name-only | grep '^public/assets/downloads/' | wc -l)
            
            git commit -m "chore(pdfs): auto-generate strategic documents [skip ci]

            üìä Generated $PDF_FILES premium PDF(s)
            üìÅ Locations:
              ‚Ä¢ lib/pdfs/: $LIB_FILES file(s)
              ‚Ä¢ public/assets/downloads/: $PUBLIC_FILES file(s)
            üìà Reports: $REPORT_FILES file(s)
            ‚è∞ Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            
            üîÑ Automated deduplication applied
            ü§ñ Generated by Strategic PDF Engine"
            
            git pull --rebase origin main
            git push
            
            echo "‚úÖ PDFs committed successfully"
          else
            echo "‚ö†Ô∏è  No files to commit"
          fi
          
      - name: üìé Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pdf-generation-logs
          path: |
            generation.log
          retention-days: 7
          
      - name: üìé Upload generated PDFs (debug)
        if: always() && steps.consolidate.outputs.unique_pdf_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: generated-strategic-pdfs
          path: |
            lib/pdfs/
            public/assets/downloads/
          retention-days: 3
          
      - name: üìä Final summary
        if: always()
        run: |
          echo ""
          echo "üéØ STRATEGIC PDF GENERATION SUMMARY"
          echo "=================================="
          echo ""
          echo "üìÖ Run: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "‚úÖ Config validation: ${{ steps.validate.outputs.config_valid || 'N/A' }}"
          echo "üì¶ Batch generation: ${{ steps.generate-batch.outputs.batch_generation_success || 'N/A' }}"
          echo "üìÑ Standalone PDF: ${{ steps.generate-standalone.outputs.standalone_generation_success || 'N/A' }}"
          echo "üèõÔ∏è  Frameworks PDF: ${{ steps.generate-frameworks.outputs.frameworks_generation_success || 'N/A' }}"
          echo "üìä Unique PDFs: ${{ steps.consolidate.outputs.unique_pdf_count || 0 }}"
          echo "üìÅ lib/pdfs count: $(find lib/pdfs -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | wc -l)"
          echo "üìÇ public/downloads count: $(find public/assets/downloads -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | wc -l)"
          echo "üìÑ Files changed: ${{ steps.check-changes.outputs.changed_files || 0 }}"
          echo ""
          
          if [ "${{ steps.verify-success.outputs.overall_success }}" = "true" ] && [ "${{ steps.verify-success.outputs.sufficient_count }}" = "true" ]; then
            echo "üéâ Mission accomplished: Premium PDFs generated successfully!"
            echo ""
            echo "üìã Generated PDFs:"
            find lib/pdfs public/assets/downloads -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | sort | uniq | xargs -I {} echo "  ‚Ä¢ {}"
          elif [ "${{ steps.verify-success.outputs.overall_success }}" = "false" ]; then
            echo "‚ùå Generation failed. Check logs for details."
          else
            echo "‚ö†Ô∏è  Generation completed with notes. Review logs if needed."
          fi
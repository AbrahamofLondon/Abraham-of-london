name: Strategic PDF Generation

on:
  push:
    branches: [main]
    paths:
      - "content/**"
      - "scripts/generate-pdfs.ts"
      - "scripts/generate-standalone-pdf.tsx"
      - "scripts/generate-frameworks-pdf.tsx"
      - "scripts/generate-legacy-canvas.ts"
      - "scripts/pdf-registry.ts"
      - "public/assets/images/**"
      - "lib/pdfs/**"
      - "package.json"
      - "pnpm-lock.yaml"
  workflow_dispatch: {}
  schedule:
    - cron: '0 4 * * 0'  # Weekly on Sunday at 4 AM UTC

jobs:
  generate-pdfs:
    runs-on: ubuntu-22.04
    timeout-minutes: 30  # Increased from 25 for better reliability
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: üìö Install dependencies
        run: |
          pnpm install --frozen-lockfile --prod=false
          echo "‚úÖ Dependencies installed"
          
      # ==================== CLEANUP PHASE ====================
      - name: üßπ Force Clean Old PDFs
        run: |
          echo "üßπ Force cleaning old PDFs..."
          # Remove everything from both directories
          rm -rf public/assets/downloads/* 2>/dev/null || true
          rm -rf lib/pdfs/* 2>/dev/null || true
          
          # Recreate directories
          mkdir -p public/assets/downloads
          mkdir -p lib/pdfs
          
          echo "‚úÖ Force clean completed"
          
      - name: üìÅ Create directories
        run: |
          mkdir -p lib/pdfs
          mkdir -p public/assets/downloads
          mkdir -p public/assets/images
          mkdir -p content
          echo "üìÅ Directory structure created"
          
      # ==================== VALIDATION PHASE ====================
      - name: üîç Validate scripts exist
        id: validate-scripts
        run: |
          echo "üîç Validating script existence..."
          
          REQUIRED_SCRIPTS=(
            "scripts/generate-pdfs.ts"
            "scripts/generate-legacy-canvas.ts"
          )
          
          MISSING_SCRIPTS=()
          for script in "${REQUIRED_SCRIPTS[@]}"; do
            if [ ! -f "$script" ]; then
              MISSING_SCRIPTS+=("$script")
            fi
          done
          
          if [ ${#MISSING_SCRIPTS[@]} -eq 0 ]; then
            echo "‚úÖ All required scripts found"
            echo "scripts_valid=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Missing scripts:"
            for script in "${MISSING_SCRIPTS[@]}"; do
              echo "  - $script"
            done
            echo "scripts_valid=false" >> $GITHUB_OUTPUT
          fi
          
      - name: üîç Validate PDF registry
        id: validate-registry
        if: steps.validate-scripts.outputs.scripts_valid == 'true'
        run: |
          echo "üîç Validating PDF registry..."
          
          # Check for pdf-registry.ts
          if [ -f "scripts/pdf-registry.ts" ]; then
            echo "‚úÖ PDF registry found"
            echo "registry_valid=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  PDF registry not found, but continuing..."
            echo "registry_valid=true" >> $GITHUB_OUTPUT  # Still true as it's optional
          fi
          
      # ==================== GENERATION PHASE ====================
      - name: üöÄ Generate all PDFs (using enhanced script)
        id: generate-batch
        if: |
          steps.validate-scripts.outputs.scripts_valid == 'true' &&
          steps.validate-registry.outputs.registry_valid == 'true'
        run: |
          echo "üöÄ Generating premium PDFs using enhanced script..."
          
          # Use the enhanced generate-pdfs.ts script directly
          if pnpm tsx scripts/generate-pdfs.ts --force-clean 2>&1 | tee generation.log; then
            echo "‚úÖ PDF generation completed"
            echo "batch_generation_success=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::PDF generation may have completed with warnings"
            # Check if any PDFs were actually generated
            PDF_COUNT=$(find public/assets/downloads -name "*.pdf" -type f 2>/dev/null | wc -l)
            if [ $PDF_COUNT -gt 0 ]; then
              echo "‚ö†Ô∏è  Generation had issues but produced $PDF_COUNT PDF(s)"
              echo "batch_generation_success=true" >> $GITHUB_OUTPUT
            else
              echo "batch_generation_success=false" >> $GITHUB_OUTPUT
            fi
          fi
          
      - name: üöÄ Generate standalone PDF (if exists)
        id: generate-standalone
        if: |
          steps.validate-scripts.outputs.scripts_valid == 'true' &&
          [ -f "scripts/generate-standalone-pdf.tsx" ]
        run: |
          echo "üöÄ Generating standalone editorial PDF..."
          
          if pnpm tsx scripts/generate-standalone-pdf.tsx 2>&1 | tee -a generation.log; then
            echo "‚úÖ Standalone PDF generation completed"
            echo "standalone_generation_success=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Standalone PDF generation failed or skipped"
            echo "standalone_generation_success=false" >> $GITHUB_OUTPUT
          fi
          
      - name: üöÄ Generate frameworks PDF (if exists)
        id: generate-frameworks
        if: |
          steps.validate-scripts.outputs.scripts_valid == 'true' &&
          [ -f "scripts/generate-frameworks-pdf.tsx" ]
        run: |
          echo "üöÄ Generating frameworks PDF..."
          
          if pnpm tsx scripts/generate-frameworks-pdf.tsx 2>&1 | tee -a generation.log; then
            echo "‚úÖ Frameworks PDF generation completed"
            echo "frameworks_generation_success=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Frameworks PDF generation failed or skipped"
            echo "frameworks_generation_success=false" >> $GITHUB_OUTPUT
          fi
          
      # ==================== CONSOLIDATION PHASE ====================
      - name: üîç Consolidate and deduplicate PDFs
        id: consolidate
        if: always()
        run: |
          echo "üîç Consolidating PDFs..."
          
          # Count PDFs in both locations
          LIB_PDFS_COUNT=$(find lib/pdfs -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | wc -l)
          PUBLIC_PDFS_COUNT=$(find public/assets/downloads -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | wc -l)
          
          echo "üìä PDF counts before consolidation:"
          echo "  lib/pdfs/: $LIB_PDFS_COUNT PDF(s)"
          echo "  public/assets/downloads/: $PUBLIC_PDFS_COUNT PDF(s)"
          
          # Ensure both directories exist
          mkdir -p lib/pdfs
          mkdir -p public/assets/downloads
          
          # Sync from lib to downloads
          if [ $LIB_PDFS_COUNT -gt 0 ]; then
            echo "üì¶ Syncing from lib/pdfs to public/assets/downloads..."
            for pdf in lib/pdfs/*.pdf; do
              if [ -f "$pdf" ]; then
                filename=$(basename "$pdf")
                cp -f "$pdf" "public/assets/downloads/$filename" 2>/dev/null || true
              fi
            done
          fi
          
          # Sync from downloads to lib
          if [ $PUBLIC_PDFS_COUNT -gt 0 ]; then
            echo "üì¶ Syncing from public/assets/downloads to lib/pdfs..."
            for pdf in public/assets/downloads/*.pdf; do
              if [ -f "$pdf" ]; then
                filename=$(basename "$pdf")
                cp -f "$pdf" "lib/pdfs/$filename" 2>/dev/null || true
              fi
            done
          fi
          
          # Final counts
          FINAL_LIB_COUNT=$(find lib/pdfs -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | wc -l)
          FINAL_PUBLIC_COUNT=$(find public/assets/downloads -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | wc -l)
          
          echo "üìä Final PDF counts:"
          echo "  lib/pdfs/: $FINAL_LIB_COUNT PDF(s)"
          echo "  public/assets/downloads/: $FINAL_PUBLIC_COUNT PDF(s)"
          
          # List all unique PDFs
          echo "üìã Generated PDF files:"
          find lib/pdfs public/assets/downloads -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | sort | uniq | xargs -I {} basename {} || echo "No PDFs found"
          
          # Output the maximum count
          if [ $FINAL_LIB_COUNT -ge $FINAL_PUBLIC_COUNT ]; then
            UNIQUE_COUNT=$FINAL_LIB_COUNT
          else
            UNIQUE_COUNT=$FINAL_PUBLIC_COUNT
          fi
          
          echo "unique_pdf_count=$UNIQUE_COUNT" >> $GITHUB_OUTPUT
          echo "lib_pdf_count=$FINAL_LIB_COUNT" >> $GITHUB_OUTPUT
          echo "public_pdf_count=$FINAL_PUBLIC_COUNT" >> $GITHUB_OUTPUT
          
      # ==================== VERIFICATION PHASE ====================
      - name: üìä Verify generation success
        id: verify-success
        run: |
          echo "üìä Verifying overall generation success..."
          
          # Get consolidated counts
          UNIQUE_COUNT="${{ steps.consolidate.outputs.unique_pdf_count || 0 }}"
          LIB_COUNT="${{ steps.consolidate.outputs.lib_pdf_count || 0 }}"
          PUBLIC_COUNT="${{ steps.consolidate.outputs.public_pdf_count || 0 }}"
          
          # Check if we have a reasonable number of PDFs
          if [ $UNIQUE_COUNT -ge 1 ]; then
            echo "‚úÖ Generated $UNIQUE_COUNT unique PDF(s)"
            echo "sufficient_count=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  No PDFs generated"
            echo "sufficient_count=false" >> $GITHUB_OUTPUT
          fi
          
          # Overall success if we have any PDFs
          if [ $UNIQUE_COUNT -gt 0 ]; then
            echo "‚úÖ PDF generation successful"
            echo "overall_success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå No PDFs were generated"
            echo "overall_success=false" >> $GITHUB_OUTPUT
          fi
          
          # Create a summary file
          cat > public/assets/downloads/generation-summary.txt << EOF
          PDF Generation Summary
          ======================
          Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          Unique PDFs: $UNIQUE_COUNT
          lib/pdfs/: $LIB_COUNT
          public/assets/downloads/: $PUBLIC_COUNT
          
          Generated Files:
          $(find public/assets/downloads -name "*.pdf" -type f 2>/dev/null | xargs -I {} basename {} | sort | sed 's/^/  ‚Ä¢ /')
          EOF
          
      # ==================== COMMIT PHASE ====================
      - name: üìÑ Check for file changes
        id: check-changes
        if: always()
        run: |
          echo "üìÑ Checking for file changes..."
          
          # Check for changes in both directories
          CHANGED_IN_LIB=$(git status --porcelain lib/pdfs/ 2>/dev/null | wc -l)
          CHANGED_IN_PUBLIC=$(git status --porcelain public/assets/downloads/ 2>/dev/null | wc -l)
          TOTAL_CHANGES=$((CHANGED_IN_LIB + CHANGED_IN_PUBLIC))
          
          if [ $TOTAL_CHANGES -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files=$TOTAL_CHANGES" >> $GITHUB_OUTPUT
            echo "üìù File changes detected:"
            echo "  lib/pdfs/: $CHANGED_IN_LIB file(s)"
            echo "  public/assets/downloads/: $CHANGED_IN_PUBLIC file(s)"
            
            # List changed files
            if [ $CHANGED_IN_LIB -gt 0 ]; then
              git status --porcelain lib/pdfs/
            fi
            if [ $CHANGED_IN_PUBLIC -gt 0 ]; then
              git status --porcelain public/assets/downloads/
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No changes detected"
          fi
          
      - name: üì§ Commit generated PDFs
        if: |
          steps.verify-success.outputs.overall_success == 'true' &&
          steps.check-changes.outputs.has_changes == 'true' &&
          steps.verify-success.outputs.sufficient_count == 'true'
        run: |
          echo "üì§ Committing generated PDFs..."
          
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Add PDFs from both locations
          git add lib/pdfs/*.pdf 2>/dev/null || true
          git add public/assets/downloads/*.pdf 2>/dev/null || true
          git add public/assets/downloads/*.json 2>/dev/null || true
          git add public/assets/downloads/*.txt 2>/dev/null || true
          
          if ! git diff --cached --quiet; then
            # Get commit details
            PDF_FILES=$(git diff --cached --name-only | grep '\.pdf$' | wc -l)
            REPORT_FILES=$(git diff --cached --name-only | grep '\.json$\|\.txt$' | wc -l)
            
            LIB_FILES=$(git diff --cached --name-only | grep '^lib/pdfs/' | wc -l)
            PUBLIC_FILES=$(git diff --cached --name-only | grep '^public/assets/downloads/' | wc -l)
            
            git commit -m "chore(pdfs): auto-generate strategic documents [skip ci]

            üìä Generated $PDF_FILES premium PDF(s)
            üìÅ Locations:
              ‚Ä¢ lib/pdfs/: $LIB_FILES file(s)
              ‚Ä¢ public/assets/downloads/: $PUBLIC_FILES file(s)
            üìà Reports: $REPORT_FILES file(s)
            ‚è∞ Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            
            üîÑ Automated deduplication applied
            ü§ñ Generated by Strategic PDF Engine"
            
            git pull --rebase origin main
            git push
            
            echo "‚úÖ PDFs committed successfully"
          else
            echo "‚ö†Ô∏è  No files to commit"
          fi
          
      # ==================== ARTIFACT PHASE ====================
      - name: üìé Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pdf-generation-logs
          path: |
            generation.log
          retention-days: 7
          
      - name: üìé Upload generated PDFs (debug)
        if: always() && steps.consolidate.outputs.unique_pdf_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: generated-strategic-pdfs
          path: |
            lib/pdfs/
            public/assets/downloads/
          retention-days: 3
          
      # ==================== SUMMARY PHASE ====================
      - name: üìä Final summary
        if: always()
        run: |
          echo ""
          echo "üéØ STRATEGIC PDF GENERATION SUMMARY"
          echo "=================================="
          echo ""
          echo "üìÖ Run: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "‚úÖ Scripts validation: ${{ steps.validate-scripts.outputs.scripts_valid || 'N/A' }}"
          echo "üìä Unique PDFs generated: ${{ steps.consolidate.outputs.unique_pdf_count || 0 }}"
          echo "üìÅ lib/pdfs count: ${{ steps.consolidate.outputs.lib_pdf_count || 0 }}"
          echo "üìÇ public/downloads count: ${{ steps.consolidate.outputs.public_pdf_count || 0 }}"
          echo "üìÑ Files changed: ${{ steps.check-changes.outputs.changed_files || 0 }}"
          echo ""
          
          if [ "${{ steps.verify-success.outputs.overall_success }}" = "true" ] && [ "${{ steps.verify-success.outputs.sufficient_count }}" = "true" ]; then
            echo "üéâ Mission accomplished: Premium PDFs generated successfully!"
            echo ""
            echo "üìã Generated PDFs:"
            find public/assets/downloads -maxdepth 1 -name "*.pdf" -type f 2>/dev/null | sort | xargs -I {} echo "  ‚Ä¢ {}"
          elif [ "${{ steps.verify-success.outputs.overall_success }}" = "false" ]; then
            echo "‚ùå Generation failed. Check logs for details."
          else
            echo "‚ö†Ô∏è  Generation completed with notes. Review logs if needed."
          fi
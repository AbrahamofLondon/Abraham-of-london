name: Strategic PDF Generation

on:
  push:
    branches: [main]
    paths:
      - "content/**"
      - "scripts/**"
      - "lib/**"
  workflow_dispatch: {}
  schedule:
    - cron: '0 4 * * 0' # Weekly on Sunday at 4 AM UTC

jobs:
  generate-pdfs:
    runs-on: ubuntu-22.04
    timeout-minutes: 45 # Increased for the growing portfolio of 79+ assets
    
    # 1. INFRASTRUCTURE: Provide a live registry for the vault audit
    services:
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # 2. SYSTEM DEPENDENCIES: The "Bouncer" that usually causes 6 months of failure
      # This ensures the Ubuntu runner can actually execute the PDF rendering engine
      - name: ðŸ”§ Install System Dependencies (Chromium/Canvas)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libgbm1 \
            libasound2

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      # 3. DIRECTORY INTEGRITY
      - name: ðŸ“ Prepare Vault Paths
        run: |
          mkdir -p public/briefs
          mkdir -p lib/pdfs
          echo "âœ… Directories prepared"

      # 4. THE MASTER ORCHESTRATION
      - name: ðŸš€ Execute Vault Master (79+ Parallel Generation)
        id: generate
        run: |
          echo "ðŸ›¡ï¸ Starting Intelligent Sync and PDF Generation..."
          # Connect to the Redis Service container defined above
          export REDIS_URL=redis://localhost:6379
          # Run the script we perfected for parallel healing and rendering
          npx tsx scripts/vault-master.ts
        env:
          NODE_OPTIONS: "--max-old-space-size=8192 --no-warnings"

      # 5. CONSOLIDATION & DEDUPLICATION
      - name: ðŸ” Sync and Cross-Reference Assets
        if: success()
        run: |
          # Ensure both directories are mirrored for the web-app and legacy links
          cp -rn public/briefs/*.pdf lib/pdfs/ 2>/dev/null || true
          cp -rn lib/pdfs/*.pdf public/briefs/ 2>/dev/null || true
          
          # Final Count for the summary
          COUNT=$(ls public/briefs/*.pdf | wc -l)
          echo "FINAL_COUNT=$COUNT" >> $GITHUB_ENV
          echo "âœ… $COUNT PDFs verified in vault."

      # 6. COMMIT RECONCILIATION
      - name: ðŸ“¤ Commit Sovereign Portfolio Updates
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add public/briefs/*.pdf lib/pdfs/*.pdf
          
          # Only commit if there are actually changes to avoid loop failures
          if ! git diff --cached --quiet; then
            git commit -m "chore(vault): auto-reconcile intelligence portfolio [${{ env.FINAL_COUNT }} assets] [skip ci]"
            git pull --rebase origin main
            git push
          else
            echo "No new changes to commit."
          fi

      - name: ðŸ“Š Upload Artifacts (Debug)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sovereign-vault-report
          path: |
            public/briefs/*.pdf
            generation.log
          retention-days: 5
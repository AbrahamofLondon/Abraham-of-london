name: Tailwind Slash-Opacity Guard

on:
  pull_request:
    paths:
      - "app/**"
      - "src/**"
      - "pages/**"
      - "components/**"
      - "content/**"
      - "styles/**"
      - "postcss/**"
      - "scripts/convert-tailwind-slash-opacity.mjs"
      - "scripts/postcss-guard-dryrun.mjs"
      - "postcss.config.js"
      - "tailwind.config.*"
      - "package.json"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  guard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile=false

      - name: Run converter in check mode
        run: node scripts/convert-tailwind-slash-opacity.mjs --check

      - name: PostCSS guard dry-run (error mode)
        run: node scripts/postcss-guard-dryrun.mjs || true

      - name: Upload PostCSS guard report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: postcss-guard-report
          path: artifacts/postcss-guard-report.txt
          if-no-files-found: warn

      - name: Fail if PostCSS guard found violations
        run: |
          if [ -f artifacts/postcss-guard-report.txt ] && grep -q "^âœ– " artifacts/postcss-guard-report.txt; then
            echo "::error::PostCSS guard found slash-opacity violations."
            exit 1
          else
            echo "No slash-opacity violations detected (or no report)."
          fi
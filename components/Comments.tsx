"useclient";import * as React from "react";import { useRouter } from "next/router";type IssueTerm="pathname"|"url"|"title"|"og:title"|(string&{});type Props={/**"owner/repo"fortheUtterancesrepo*/repo?:string;issueTerm?:IssueTerm;//default:"pathname"label?:string;//optionalGitHubIssueslabeluseClassDarkMode?:boolean;//syncwith<htmlclass="dark">rootMargin?:string;//lazy-mountmarginthreshold?:number;//lazy-mountthresholdclassName?:string;/**Howlongtowaitbeforedeclaringloadfailure(ms).Default10000.*/timeoutMs?:number;/**Howoftentopollforiframepresence(ms).Default250.*/pollMs?:number;};constUTTERANCES_ORIGIN="https://utteranc.es";constIFRAME_SELECTOR="iframe.utterances-frame";//Allowoverrideviaenv;fallsbacktothecorrectowner/repoconstDEFAULT_REPO=(process.env.NEXT_PUBLIC_UTTERANCES_REPOasstring|undefined)??"AbrahamofLondon/abrahamoflondon-comments";export defaultfunctionComments({repo=DEFAULT_REPO,issueTerm="pathname",label,useClassDarkMode=true,rootMargin="200px",threshol d=0.1,className,timeoutMs=10_000,pollMs=250,}:Props){constrouter=useRouter();constcontainerRef=React.useRef<HTMLDivElement|null>(null);const[loading,setLoading]=React.useState(true);const[error,setError]=React.useState<string|null>(null);const[readyToMount,setReadyToMount]=React.useState(false);constisRepoVal i d=React.useMemo(()=>/^[^/]+\/[^/]+$/.test(repo),[repo]);constcomputeInitialTheme=React.useCallback(():string=>{if(typeofdocument==="undefined")return"preferred-color-scheme";if(useClassDarkMode){constisDark=document.documentElement.classList.contains("dark");returnisDark?"github-dark":"github-light";}return"preferred-color-scheme";},[useClassDarkMode]);constpostThemeToIframe=React.useCallback((theme:string)=>{try{constframe=containerRef.current?.querySelector<HTMLIFrameElement>(IFRAME_SELECTOR);frame?.contentWindow?.postMessage({type:"set-theme",theme},UTTERANCES_ORIGIN);}catch{/*no-op*/}},[]);/**Mountutterancesscriptintotheprovidedhostelement.*/constmountUtterances=React.useCallback((host:HTMLDivElement|null|undefined)=>{if(!host)return()=>{};if(!isRepoValid){setError('Invalid"repo"format.Use"owner/repo",e.g."AbrahamofLondon/abrahamoflondon-comments".');setLoading(false);return()=>{};}//Clearoldnodeswhile(host.firstChild)host.removeChild(host.firstChild);setLoading(true);setError(null);constscript=document.createElement("script");script.src=`${UTTERANCES_ORIGIN}/client.js`;script.async=true;script.crossOrigin="anonymous";script.setAttribute("repo",repo);script.setAttribute("issue-term",issueTerm);if(label?.trim())script.setAttribute("label",label.trim());script.setAttribute("theme",computeInitialTheme());const onError=()=>{setError("Commentsfailedtoload.Ensuretherepoexists(public),Issuesareenabled,andtheUtterancesapphasaccess.");setLoading(false);};script.addEventListener("error",onError);host.appendChild(script);constpollI d=window.setInterval(()=>{consthasFrame=!!host.querySelector(IFRAME_SELECTOR);if(hasFrame){window.clearInterval(pollId);setLoading(false);}},Math.max(50,pollMs));consttimeoutI d=window.setTimeout(()=>{consthasFrame=!!host.querySelector(IFRAME_SELECTOR);if(!hasFrame)onError();},Math.max(1000,timeoutMs));//Cleanupreturn()=>{script.removeEventListener("error",onError);window.clearInterval(pollId);window.clearTimeout(timeoutId);};},[repo,issueTerm,label,computeInitialTheme,isRepoValid,pollMs,timeoutMs]);//LazytriggerformountingwhenvisibleReact.useEffect(()=>{if(typeofwindow==="undefined"||readyToMount)return;consthost=containerRef.current;if(!host)return;constrect=host.getBoundingClientRect();constinView=rect.top<window.innerHeight&&rect.bottom>=0;if(inView){setReadyToMount(true);return;}constio=newIntersectionObserver((entries)=>{if(entries.some((e)=>e.isIntersecting)){setReadyToMount(true);io.disconnect();}},{root:null,rootMargin,threshold});io.observe(host);return()=>io.disconnect();},[readyToMount,rootMargin,threshold]);//Actualmountoncevisible,andre-mountonSPAroutechangesReact.useEffect(()=>{if(!readyToMount)return;consthost=containerRef.current;constcleanup=mountUtterances(host);return()=>{cleanup?.();if(host)while(host.firstChild)host.removeChild(host.firstChild);};},[readyToMount,mountUtterances,router.asPath]);//re-runonroutechange//Keepiframethemesynced(debouncedviarAF)—no@ts-expect-errorneededReact.useEffect(()=>{if(typeofwindow==="undefined")return;letmqCleanup:(()=>void)|null=null;letclassObserver:MutationObserver|null=null;letraf=0;constschedule=(isDark:boolean)=>{cancelAnimationFrame(raf);raf=requestAnimationFrame(()=>{postThemeToIframe(isDark?"github-dark":"github-light");});};if(useClassDarkMode){class Observer=newMutationObserver(()=>{constisDark=document.documentElement.classList.contains("dark");schedule(isDark);});class Observer.observe(document.documentElement,{attributes:true,attributeFilter:["class"],});schedule(document.documentElement.classList.contains("dark"));}elseif(window.matchMedia){constmql=window.matchMedia("(prefers-color-scheme:dark)");const onChange=()=>schedule(mql.matches);//Modernmql.addEventListener?.("change",onChange);//Safarilegacyif("addListener"inmql&&typeof(mqlasany).addListener==="function"){(mqlasany).addListener(onChange);}mqCleanup=()=>{mql.removeEventListener?.("change",onChange);if("removeListener"inmql&&typeof(mqlasany).removeListener==="function"){(mqlasany).removeListener(onChange);}};schedule(mql.matches);}return()=>{class Observer?.disconnect();mqCleanup?.();cancelAnimationFrame(raf);};},[useClassDarkMode,postThemeToIframe]);return(<section aria-labelledby="comments-title"className={["mt-16",className||""].join("").trim()}><h2i d="comments-title"className="sr-only">Comments</h2>{/*KeybyroutetoguaranteeremountonSPAnavigations*/}<divkey={router.asPath}ref={containerRef}className="min-h-[120px]"/>{(loading||error)&&(<p role="status"aria-live="polite"className="mt-4text-sm">{loading&&!error&&<span className="text-[color:var(--color-on-secondary)/0.7]">Loadingcomments...</span>}{error&&<span className="text-red-600">{error}</span>}</p>)}<noscript><p className="mt-4text-smtext-[color:var(--color-on-secondary)/0.7]">CommentsrequireJavaScript.Pleaseenableittoviewandpost.</p></noscript></section>);}
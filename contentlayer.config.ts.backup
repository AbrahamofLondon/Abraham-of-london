// contentlayer.config.ts
// Enterprise-Grade Content Configuration
// Windows-compatible, production-optimized, error-resilient

import { defineDocumentType, makeSource } from "contentlayer2/source-files";
import remarkGfm from "remark-gfm";
import rehypeSlug from "rehype-slug";
import rehypeAutolinkHeadings from "rehype-autolink-headings";
import path from "path";
import fs from "fs";

/* ========================================================================== */
/* PLATFORM COMPATIBILITY & SAFETY LAYER                                      */
/* ========================================================================== */

const IS_WINDOWS = process.platform === 'win32';
const IS_PRODUCTION = process.env.NODE_ENV === 'production';

/**
 * Windows-safe path normalization
 * Handles backslashes, duplicate slashes, and preserves network paths
 */
const normalizePathForPlatform = (filePath: string): string => {
  if (!filePath || typeof filePath !== 'string') return '';
  
  // Handle Windows paths
  let normalized = filePath.replace(/\\/g, '/');
  
  // Remove duplicate slashes but preserve protocol (like file://)
  normalized = normalized.replace(/([^:]\/)\/+/g, '$1');
  
  return normalized;
};

/**
 * Safe file existence check with error suppression
 */
const safeFileExists = (filePath: string): boolean => {
  try {
    const normalized = normalizePathForPlatform(filePath);
    return fs.existsSync(normalized);
  } catch (error) {
    if (!IS_PRODUCTION) {
      console.warn(`[Contentlayer] Could not check file: ${filePath}`, error.message);
    }
    return false;
  }
};

/**
 * Generate deterministic slug from file path
 */
const generateSlug = (filePath: string): string => {
  const normalized = normalizePathForPlatform(filePath);
  const fileName = path.basename(normalized, path.extname(normalized));
  
  return fileName
    .toLowerCase()
    .replace(/[^a-z0-9-]/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '')
    || 'untitled';
};

/* ========================================================================== */
/* FIELD SCHEMA FACTORY (Type-safe, extensible)                               */
/* ========================================================================== */

type FieldType = 'string' | 'number' | 'boolean' | 'date' | 'list' | 'json';
type FieldDefinition = {
  type: FieldType;
  required: boolean;
  default?: any;
  of?: { type: FieldType };
};

const createFieldSchema = () => ({
  // Core metadata
  title: { type: 'string' as const, required: true },
  description: { type: 'string' as const, required: false },
  excerpt: { type: 'string' as const, required: false },
  
  // Dates
  date: { type: 'date' as const, required: true },
  updated: { type: 'date' as const, required: false },
  publishDate: { type: 'date' as const, required: false },
  expireDate: { type: 'date' as const, required: false },
  
  // Content identification
  slug: { type: 'string' as const, required: false },
  canonicalUrl: { type: 'string' as const, required: false },
  
  // Categorization
  category: { type: 'string' as const, required: false },
  categories: { 
    type: 'list' as const, 
    of: { type: 'string' as const }, 
    required: false 
  },
  tags: { 
    type: 'list' as const, 
    of: { type: 'string' as const }, 
    required: false 
  },
  
  // Authorship
  author: { type: 'string' as const, required: false },
  authors: { 
    type: 'list' as const, 
    of: { type: 'string' as const }, 
    required: false 
  },
  
  // Visual assets
  coverImage: { type: 'string' as const, required: false },
  coverAspect: { type: 'string' as const, required: false },
  
  // Layout & theming
  layout: { type: 'string' as const, required: false },
  theme: { type: 'string' as const, required: false },
  
  // Reading metrics
  readTime: { type: 'string' as const, required: false },
  wordCount: { type: 'number' as const, required: false },
  
  // Publication status
  draft: { type: 'boolean' as const, required: false, default: false },
  published: { type: 'boolean' as const, required: false, default: true },
  featured: { type: 'boolean' as const, required: false, default: false },
  
  // Access control
  tier: { type: 'string' as const, required: false, default: 'free' },
  accessLevel: { type: 'string' as const, required: false },
  
  // SEO
  metaDescription: { type: 'string' as const, required: false },
  keywords: { 
    type: 'list' as const, 
    of: { type: 'string' as const }, 
    required: false 
  },
  
  // Asset links (safe for Windows)
  file: { type: 'string' as const, required: false },
  downloadFile: { type: 'string' as const, required: false },
  fileSize: { type: 'string' as const, required: false },
  
  // Structured data
  resources: { type: 'json' as const, required: false },
  meta: { type: 'json' as const, required: false },
});

/* ========================================================================== */
/* COMPUTED FIELDS FACTORY (Error-resilient)                                  */
/* ========================================================================== */

const createComputedFields = (basePath: string) => ({
  url: {
    type: 'string' as const,
    resolve: (doc: any) => {
      try {
        if (doc.canonicalUrl) return doc.canonicalUrl;
        const slug = doc.slug || generateSlug(doc._raw.flattenedPath);
        return `/${basePath}/${slug}`;
      } catch (error) {
        return `/${basePath}/error`;
      }
    }
  },

  computedSlug: {
    type: 'string' as const,
    resolve: (doc: any) => {
      try {
        return doc.slug || generateSlug(doc._raw.flattenedPath);
      } catch (error) {
        return 'error-slug';
      }
    }
  },

  isPublished: {
    type: 'boolean' as const,
    resolve: (doc: any) => {
      return (doc.published !== false) && !doc.draft;
    }
  },

  computedReadingTime: {
    type: 'string' as const,
    resolve: (doc: any) => {
      return doc.readTime || '5 min read';
    }
  },

  computedTier: {
    type: 'string' as const,
    resolve: (doc: any) => doc.tier || 'free'
  },

  fileInfo: {
    type: 'json' as const,
    resolve: (doc: any) => {
      try {
        const path = doc.file || doc.downloadFile || '';
        const normalized = normalizePathForPlatform(path);
        return {
          path: normalized,
          size: doc.fileSize || null,
          extension: path ? path.split('.').pop()?.toLowerCase() : null,
          exists: path ? safeFileExists(path) : false
        };
      } catch (error) {
        return { error: 'Could not compute file info' };
      }
    }
  }
});

/* ========================================================================== */
/* DOCUMENT TYPE FACTORY (Robust pattern matching)                            */
/* ========================================================================== */

const createDocumentType = (
  name: string,
  pattern: string,
  basePath: string
) => {
  return defineDocumentType(() => ({
    name,
    filePathPattern: pattern,
    contentType: 'mdx' as const,
    fields: createFieldSchema(),
    computedFields: createComputedFields(basePath)
  }));
};

/* ========================================================================== */
/* DOCUMENT TYPE DEFINITIONS (Your existing types, enhanced)                  */
/* ========================================================================== */

export const Post = createDocumentType("Post", "blog/**/*.{md,mdx}", "blog");
export const Canon = createDocumentType("Canon", "canon/**/*.{md,mdx}", "canon");
export const Book = createDocumentType("Book", "books/**/*.{md,mdx}", "books");
export const Short = createDocumentType("Short", "shorts/**/*.{md,mdx}", "shorts");
export const Event = createDocumentType("Event", "events/**/*.{md,mdx}", "events");
export const Resource = createDocumentType("Resource", "resources/**/*.{md,mdx}", "resources");
export const Strategy = createDocumentType("Strategy", "strategy/**/*.{md,mdx}", "strategy");
export const Article = createDocumentType("Article", "articles/**/*.{md,mdx}", "articles");
export const Guide = createDocumentType("Guide", "guides/**/*.{md,mdx}", "guides");
export const Tutorial = createDocumentType("Tutorial", "tutorials/**/*.{md,mdx}", "tutorials");
export const CaseStudy = createDocumentType("CaseStudy", "case-studies/**/*.{md,mdx}", "case-studies");
export const Whitepaper = createDocumentType("Whitepaper", "whitepapers/**/*.{md,mdx}", "whitepapers");
export const Report = createDocumentType("Report", "reports/**/*.{md,mdx}", "reports");
export const Newsletter = createDocumentType("Newsletter", "newsletters/**/*.{md,mdx}", "newsletters");
export const Sermon = createDocumentType("Sermon", "sermons/**/*.{md,mdx}", "sermons");
export const Devotional = createDocumentType("Devotional", "devotionals/**/*.{md,mdx}", "devotionals");
export const Prayer = createDocumentType("Prayer", "prayers/**/*.{md,mdx}", "prayers");
export const Testimony = createDocumentType("Testimony", "testimonies/**/*.{md,mdx}", "testimonies");
export const Podcast = createDocumentType("Podcast", "podcasts/**/*.{md,mdx}", "podcasts");
export const Video = createDocumentType("Video", "videos/**/*.{md,mdx}", "videos");
export const Course = createDocumentType("Course", "courses/**/*.{md,mdx}", "courses");
export const Lesson = createDocumentType("Lesson", "lessons/**/*.{md,mdx}", "lessons");
export const Print = createDocumentType("Print", "prints/**/*.{md,mdx}", "prints");
export const Download = createDocumentType("Download", "downloads/**/*.{md,mdx}", "downloads");

/* ========================================================================== */
/* SECURE FILE SYSTEM PATHS (Windows-safe exclusions)                         */
/* ========================================================================== */

const SECURE_EXCLUSIONS = [
  // System directories (absolute safety)
  "**/node_modules/**",
  "**/.git/**",
  "**/.next/**",
  "**/.contentlayer/**",
  
  // Public assets (prevent font/permission issues)
  "**/public/**",
  "**/fonts/**",
  "**/assets/**",
  "**/uploads/**",
  
  // Binary/non-text files
  "**/*.ttf",
  "**/*.woff",
  "**/*.woff2",
  "**/*.otf",
  "**/*.eot",
  "**/*.jpg",
  "**/*.jpeg",
  "**/*.png",
  "**/*.gif",
  "**/*.svg",
  "**/*.pdf",
  "**/*.zip",
  "**/*.exe",
  "**/*.dll",
  "**/*.so",
  "**/*.dylib",
  
  // Configuration and secrets
  "**/.env*",
  "**/*.secret*",
  "**/*.key*",
  
  // Temporary files
  "**/tmp/**",
  "**/temp/**",
  "**/*.tmp",
  "**/*.temp",
];

/* ========================================================================== */
/* MAIN CONFIGURATION (Production-ready, error-resilient)                     */
/* ========================================================================== */

export default makeSource({
  // Core configuration
  contentDirPath: "content",
  contentDirExclude: SECURE_EXCLUSIONS,
  
  // Document types (your complete set)
  documentTypes: [
    Post, Canon, Book, Short, Event, Resource, Strategy,
    Article, Guide, Tutorial, CaseStudy, Whitepaper, Report, Newsletter,
    Sermon, Devotional, Prayer, Testimony, Podcast, Video, Course, Lesson, Print, Download
  ],
  
  // MDX processing
  mdx: {
    remarkPlugins: [remarkGfm],
    rehypePlugins: [
      rehypeSlug,
      [rehypeAutolinkHeadings, { 
        behavior: 'wrap',
        properties: {
          className: ['heading-anchor'],
          'aria-hidden': 'true'
        }
      }]
    ],
    
    // Error handling in MDX compilation
    onCompileError: (error, filePath) => {
      if (!IS_PRODUCTION) {
        console.warn(`[Contentlayer] MDX compile error in ${filePath}:`, error.message);
      }
      return null; // Skip problematic files rather than failing
    },
  },
  
  // Error resilience configuration
  onUnknownDocuments: "skip-warn",
  onMissingOrIncompatibleData: "skip-warn",
  onExtraFieldData: "skip-warn",
  
  // Performance optimizations
  disableImportAliasWarning: true,
  date: { timezone: "UTC" },
  
  // File system safety
  disableRecursivePathScan: true,
  
  // Build optimization
  onSuccess: async () => {
    if (!IS_PRODUCTION) {
      console.log('✅ Contentlayer build completed successfully');
    }
  },
  
  onError: (error) => {
    console.error('❌ Contentlayer build failed:', error.message);
    
    // In production, fail fast
    if (IS_PRODUCTION) {
      throw error;
    }
    
    // In development, continue with degraded functionality
    console.warn('⚠️  Continuing with degraded content functionality');
  },
});

/* ========================================================================== */
/* TYPE EXPORTS FOR CONSUMERS                                                 */
/* ========================================================================== */

export type { DocumentTypes } from 'contentlayer2/generated';
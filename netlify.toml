# =====================================================================
# FINAL, CORRECTED NETLIFY.TOML
# This version enforces the clean 'prod:build' command for all contexts.
# =====================================================================

[build]
  # ✅ CORRECTED: Use the clean production build script.
  command = "npm run prod:build"
  publish = ".next"

[build.environment]
  NODE_VERSION = "20"
  NEXT_TELEMETRY_DISABLED = "1"
  NEXT_PUBLIC_SITE_URL = "https://www.abrahamoflondon.org"
  CI_LAX = "1"
  NO_SLASH_OPACITY_MODE = "fix"
  DOWNLOADS_STRICT = "0"
  NODE_OPTIONS = "--max_old_space_size=4096"

[context.production]
  # ✅ FIX: Explicitly set the clean command for production
  command = "npm run prod:build"

[context.production.environment]
  NODE_ENV = "production"
  NODE_VERSION = "20"
  NEXT_PUBLIC_SITE_URL = "https://www.abrahamoflondon.org"
  CI_LAX = "1"
  NO_SLASH_OPACITY_MODE = "fix"
  DOWNLOADS_STRICT = "0"

[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  external_node_modules = ["resend"]

[functions."send-teaser"]
  included_files = ["netlify/emails/**"]

[functions."subscribe"]
  included_files = ["netlify/emails/**"]

[functions."subscribe-launch"]
  included_files = ["netlify/emails/**"]

[[plugins]]
  package = "@netlify/plugin-nextjs"

# ... (The rest of the redirects and headers are correct) ...
// netlify/functions/clear-cache.ts
import type {
  Handler,
  HandlerEvent,
  HandlerContext,
  HandlerResponse,
} from "@netlify/functions";
import { ok, bad, readJson, withSecurity } from "./_utils";

export const handler: Handler = withSecurity(
  async (
    event: HandlerEvent,
    _context: HandlerContext
  ): Promise<HandlerResponse> => {
    const origin = event.headers.origin || event.headers.Origin || "*";

    try {
      const body = await readJson<{ secret?: string }>({
        headers: event.headers,
        body: event.body || "",
      });

      const validSecret = process.env.CLEAR_CACHE_SECRET;
      if (!validSecret) {
        return bad(
          "Clear cache functionality not configured",
          500,
          origin
        );
      }

      if (body.secret !== validSecret) {
        return bad("Invalid secret", 401, origin);
      }

      console.log("Cache clear requested at:", new Date().toISOString());

      // TODO: add real cache invalidation here (CDN, Redis, etc.)

      return ok(
        "Cache cleared successfully",
        {
          timestamp: new Date().toISOString(),
          cleared: true,
        },
        origin
      );
    } catch (err: unknown) {
      const message =
        err instanceof Error
          ? err.message
          : "Unknown error parsing request";
      return bad(message, 400, origin);
    }
  },
  {
    requireRecaptcha: false,
    requireHoneypot: true,
  }
);
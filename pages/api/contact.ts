//pages/api/contact.tsimporttype{NextApiRequest,NextApiResponse}from "next";type Ok={ok:true;message:string};type Err={ok:false;message:string};//RegexforbasicemailformatvalidationconstEMAIL_RE=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;//Publicteaserpaths(makesurebothfilesexistunder/public/downloads/)constTEASER_A4="/downloads/Fathering_Without_Fear_Teaser-A4.pdf";constTEASER_MOB="/downloads/Fathering_Without_Fear_Teaser-Mobile.pdf";export defaultasyncfunctionhandler(req:NextApiRequest,res:NextApiResponse<Ok|Err>){if(req.method!=="POST"){res.setHeader("Allow","POST");returnres.status(405).json({ok:false,message:"MethodNotAllowed"});}try{constbody=typeofreq.body==="string"?safeParse(req.body):(req.body||{});//Inputsanitizationandlimitsconstname=String((bodyasany).name||"").trim().slice(0,100);constemail=String((bodyasany).email||"").trim().toLowerCase();constsubject=String((bodyasany).subject||"Websitecontact").trim().slice(0,120);constmessage=String((bodyasany).message||"").trim();consthoneypot=String((bodyasany)["bot-field"]||(bodyasany).botField||"").trim();//Newflags(checkboxesontheform/FloatingTeaserCTA,etc.)constteaserOptIn=!!(bodyasany).teaserOptIn;constnewsletterOptIn=!!(bodyasany).newsletterOptIn;//URLsforemailcontentconstSITE_URL=process.env.NEXT_PUBLIC_SITE_URL||process.env.URL||process.env.DEPLOY_PRIME_URL||"https://www.abrahamoflondon.org";constteaserA4Url=abs(SITE_URL,TEASER_A4);constteaserMobUrl=abs(SITE_URL,TEASER_MOB);//---Validation---if(honeypot)returnres.status(200).json({ok:true,message:"Messagesentsuccessfully!"});if(!email||!message)returnres.status(400).json({ok:false,message:"Required:email,message"});if(!EMAIL_RE.test(email))returnres.status(400).json({ok:false,message:"Invalidemailformat"});if(message.length<5)returnres.status(400).json({ok:false,message:"Messageistooshort"});//Devloggingif(process.env.NODE_ENV!=="production"){constmaskedEmail=email.replace(/^(.).+(@.*)$/,"$1***$2");console.log("[contact]submission:",{name:name||"—",email:maskedEmail,subject,messageLength:message.length,teaserOptIn,newsletterOptIn,});}//OptionalemailsendingviaResendconstprovider=(process.env.CONTACT_PROVIDER||"").toLowerCase();if(provider==="resend"){constapiKey=process.env.RESEND_API_KEY;constto=process.env.MAIL_TO||"info@abrahamoflondon.org";constfrom=process.env.MAIL_FROM||"AbrahamofLondon<no-reply@abrahamoflondon.org>";if(!apiKey)returnres.status(500).json({ok:false,message:"Emailprovidernotconfigured"});//1)NotifyownerconstownerHtml=ownerNoticeHtml({name,email,subject,message,teaserOptIn,newsletterOptIn});constownerResp=awaitsendViaResend({apiKey,from,to,subject:`Newcontact:${name||"Anonymous"}`,html:ownerHtml,replyTo:{email,name:name||email},//Passreply-toinfo});if(!ownerResp.ok){console.error("[contact]Resendownersendfailed:",ownerResp.status,ownerResp.body);//Continuetoattemptauto-reply}//2)Auto-replywithteaser(ifoptedin)if(teaserOptIn){constautoHtml=teaserAutoReplyHtml({teaserA4Url,teaserMobUrl,siteUrl:SITE_URL});constautoText=teaserAutoReplyText({teaserA4Url,teaserMobUrl,siteUrl:SITE_URL});constautoResp=awaitsendViaResend({apiKey,from,to:email,//Sendtothecustomer'semailsubject:"FatheringWithoutFear—Teaser(A4+Mobile)",html:autoHtml,text:autoText,});if(!autoResp.ok){console.error("[contact]Resendteaserauto-replyfailed:",autoResp.status,autoResp.body);}}//3)Newsletteropt-in(notifyownerorintegrateyourESPhere)if(newsletterOptIn){constnlHtml=`<divstyle="font-family:system-ui,-apple-system,SegoeUI,Roboto,Arial,sans-serif;font-size:16px;line-height:1.5;color:#111"><h3>Newsletteropt-in—FatheringWithoutFear</h3><p><strong>Name:</strong>${escapeHtml(name||"—")}</p><p><strong>Email:</strong>${escapeHtml(email)}</p><p>Pleaseaddtothelaunch/chapterslist.</p></div>`.trim();constnlResp=awaitsendViaResend({apiKey,from,to,//Sendtotheownersubject:"Newsletteropt-in—FatheringWithoutFear",html:nlHtml,});if(!nlResp.ok){console.error("[contact]Resendnewsletternotefailed:",nlResp.status,nlResp.body);}//IfyouuseanESP(ConvertKit/Beehiiv/etc.),callitssubscriptionAPIhereinstead.}}returnres.status(200).json({ok:true,message:"Messagesentsuccessfully!"});}catch(e){console.error("[contact]handlererror:",e);returnres.status(500).json({ok:false,message:"InternalServerError"});}}/*----------------helpers----------------*//**GeneratesanabsoluteURLfromabasesiteURLandapath.*/function abs(site:string,p:string){if(!p)returnsite;try{returnnewURL(p,site).toString();}catch{//Fallbackfortrickyenvironments/URLsreturn`${site}${p.startsWith("/")?"":"/"}${p}`;}}/**SafelyparsesaJSONstring,returninganemptyobjectonfailure.*/function safeParse(s:string){try{returnJSON.parse(s);}catch{return{};}}/**EscapesHTMLspecialcharactersforsafeemailtemplateinjection.*/function escapeHtml(str:string){returnString(str).replace(/[&<>"']/g,(m)=>//ðŸŒŸTHISISTHECORRECTEDLINEðŸŒŸ//FixesthesyntaxerrorandusescorrectHTMLentitiesforrobustescaping({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}asconst)[m]||m);}//---EmailContentGenerators---/**HTMLcontentfortheownernotificationemail.*/function ownerNoticeHtml(args:{name:string;email:string;subject:string;message:string;teaserOptIn:boolean;newsletterOptIn:boolean;}){const{name,email,subject,message,teaserOptIn,newsletterOptIn}=args;return`<divstyle="font-family:system-ui,-apple-system,SegoeUI,Roboto,Arial,sans-serif;font-size:16px;line-height:1.55;color:#111"><h2>Newwebsiteinquiry</h2><p><strong>Name:</strong>${escapeHtml(name||"—")}</p><p><strong>Email:</strong>${escapeHtml(email)}</p><p><strong>Subject:</strong>${escapeHtml(subject)}</p><p><strong>Teaserrequested:</strong>${teaserOptIn?"Yes":"No"}</p><p><strong>Newsletteropt-in:</strong>${newsletterOptIn?"Yes":"No"}</p><p><strong>Message:</strong></p><prestyle="white-space:pre-wrap;background-color:#f7f7f7;padding:10px;border-radius:5px;">${escapeHtml(message)}</pre></div>`.trim();}/**HTMLcontentfortheauto-replyemailwiththeteaserlinks.*/function teaserAutoReplyHtml(args:{teaserA4Url:string;teaserMobUrl:string;siteUrl:string}){const{teaserA4Url,teaserMobUrl,siteUrl}=args;return`<divstyle="font-family:system-ui,-apple-system,SegoeUI,Roboto,Helvetica,Arial,sans-serif;line-height:1.6;color:#222"><p>Friends—</p><p>I'mreleasing<em>FatheringWithoutFear</em>,amemoirforgedinthemiddleofloss,legalstorms,andafather'sstubbornhope.</p><p>Here'syourfree,brand-styledteaser(A4+Mobile)toreadandshare:</p><ul><li><ahref="${teaserA4Url}">TeaserPDF(A4/Letter)</a></li><li><ahref="${teaserMobUrl}">TeaserPDF(Mobile)</a></li></ul><p>Ifyouwantchapterdropsandlaunchdates,reply"keepmeposted"orjointhelisthere:<ahref="${siteUrl}/contact">${siteUrl}/contact</a></p><p>Graceandcourage,<br/>AbrahamofLondon</p></div>`.trim();}/**Plaintextcontentfortheauto-replyemail.*/function teaserAutoReplyText(args:{teaserA4Url:string;teaserMobUrl:string;siteUrl:string}){const{teaserA4Url,teaserMobUrl,siteUrl}=args;return`Subject:FatheringWithoutFear—thestorytheythoughttheyknewFriends—I'mreleasingFatheringWithoutFear,amemoirforgedinthemiddleofloss,legalstorms,andafather'sstubbornhope.Freeteaser(A4+Mobile):—${teaserA4Url}—${teaserMobUrl}Forchapterdropsandlaunchdates,reply"keepmeposted"orjoin:${siteUrl}/contactGraceandcourage,AbrahamofLondon`.trim();}//---ResendAPIIntegration---/**SendsanemailusingtheResendAPI.*/asyncfunctionsendViaResend(args:{apiKey:string;from:string;to:string;subject:string;html:string;text?:string;replyTo?:{email:string;name?:string};}):Promise<{ok:boolean;status:number;body?:any}>{const{apiKey,from,to,subject,html,text,replyTo}=args;constpayload:any={from,to,subject,html};if(text)payload.text=text;//Resend'sAPIacceptsasingleemailstringforreply_toif(replyTo?.email){//Createthestringformat:"Name<email@example.com>"payload.reply_to=replyTo.name?`${replyTo.name}<${replyTo.email}>`:replyTo.email;}constr=awaitfetch("https://api.resend.com/emails",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer${apiKey}`},body:JSON.stringify(payload),});letbody:any=null;try{body=awaitr.json();}catch{body=null;}return{ok:r.ok,status:r.status,body};}

//pages/api/newsletter.tsimporttype{NextApiRequest,NextApiResponse}from "next";import cryptofrom"crypto";//onlyusedforMailchimppathexportconstconfig={api:{bodyParser:true}};//ensureNode/APIparsing//Forcenoderuntime(import antonsomehosts)export construntime="nodejs";type Json={ok:boolean;message:string};constEMAIL_RE=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;constasBool=(v?:string,def=true)=>(v==null?def:/^true$/i.test(v.trim()));export defaultasyncfunctionhandler(req:NextApiRequest,res:NextApiResponse<Json>){res.setHeader("Cache-Control","no-store");//---tinyhealthcheck---if(req.metho d==="GET"&&(req.query.debug==="1"||req.query.debug==="true")){constprovider=(process.env.EMAIL_PROVIDER||process.env.NEXT_PUBLIC_EMAIL_PROVIDER||"").trim().toLowerCase()||"auto";consthasBD=Boolean((process.env.BUTTONDOWN_API_KEY||"").trim());consthasMC=Boolean((process.env.MAILCHIMP_API_KEY||"").trim())&&Boolean((process.env.MAILCHIMP_LIST_ID||"").trim());returnres.status(200).json({ok:true,message:`newsletterendpointOK(provider=${provider};buttondown=${hasBD};mailchimp=${hasMC})`,});}if(req.method!=="POST"){res.setHeader("Allow","POST,GET");returnres.status(405).json({ok:false,message:"Methodnotallowed"});}try{//AcceptEITHER{email}OR{payload:{email_address}}constraw=typeofreq.body==="string"?safeParse(req.body):(req.body??{});constemailFromPlain=safeString((rawasany)?.email);constemailFromPayloa d=safeString((rawasany)?.payload?.email_address);constemail=(emailFromPlain||emailFromPayload||"").toLowerCase().trim();if(!EMAIL_RE.test(email)){returnres.status(400).json({ok:false,message:"Validemailisrequired"});}//Decideproviderletprovider=(process.env.EMAIL_PROVIDER||process.env.NEXT_PUBLIC_EMAIL_PROVIDER||"").trim().toLowerCase();if(!provider){if((process.env.BUTTONDOWN_API_KEY||"").trim())provider="buttondown";elseif((process.env.MAILCHIMP_API_KEY||"").trim()&&(process.env.MAILCHIMP_LIST_ID||"").trim())provider="mailchimp";}//--------------------BUTTONDOWN--------------------if(provider==="buttondown"){consttoken=(process.env.BUTTONDOWN_API_KEY||"").trim();if(!token){returnres.status(500).json({ok:false,message:"Buttondownnotconfigured"});}constheaders={"Content-Type":"application/json","Accept":"application/json","Authorization":`Token${token}`,};//1)Trythecanonicalshape:{email}letr=awaitfetchWithTimeout("https://api.buttondown.email/v1/subscribers",{method:"POST",headers,body:JSON.stringify({email}),timeoutMs:12_000,});letresp:any=awaitsafeJson(r);//SomeButtondownclustersreply422withaPydanticerroraskingforpayload.email_addressconstneedsAltShape=r.status===422&&isPydanticArray(resp)&&resp.some((e:any)=>String(e?.loc?.join(".")||"").toLowerCase().includes("payload.email_address")||String(e?.msg||"").toLowerCase().includes("fieldrequired"));if(needsAltShape){r=awaitfetchWithTimeout("https://api.buttondown.email/v1/subscribers",{method:"POST",headers,body:JSON.stringify({payload:{email_address:email}}),timeoutMs:12_000,});resp=awaitsafeJson(r);}if(r.ok||r.status===201){returnres.status(200).json({ok:true,message:"You'resubscribed.Welcome!"});}//Friendlyalready-subscribedconsttxt=JSON.stringify(resp||{}).toLowerCase();if(r.status===400||r.status===422){if(txt.includes("already")||txt.includes("exists")){returnres.status(200).json({ok:true,message:"You'realreadysubscribed."});}}if(r.status===401){returnres.status(401).json({ok:false,message:"Buttondownauthfailed(checkAPIkey)."});}if(r.status===429){returnres.status(429).json({ok:false,message:"RatelimitedbyButtondown.Tryagainshortly."});}//Optionaldebugecho:pass?debug=post=1tosurfaceButtondown'smessageconstshowDebug=String(req.query.debug||"").includes("post");constmsg=(typeofresp?.detail==="string"&&resp.detail)||(typeofresp?.message==="string"&&resp.message)||firstErrorString(resp)||(showDebug?`Buttondownerror(status${r.status}):${JSON.stringify(resp)}`:"Buttondownerror");returnres.status(r.status||500).json({ok:false,message:msg});}//--------------------MAILCHIMP--------------------if(provider==="mailchimp"){constkey=(process.env.MAILCHIMP_API_KEY||"").trim();constlistI d=(process.env.MAILCHIMP_LIST_ID||"").trim();constdoubleOpt=asBool(process.env.MAILCHIMP_DOUBLE_OPT_IN,true);if(!key||!listId||!/-[a-z0-9]{2,}$/i.test(key)){returnres.status(500).json({ok:false,message:"Mailchimpnotconfigured"});}constdc=key.split("-").pop()!;//e.g."us6"consthash=crypto.createHash("md5").update(email).digest("hex");consturl=`https://${dc}.api.mailchimp.com/3.0/lists/${listId}/members/${hash}`;constr=awaitfetchWithTimeout(url,{method:"PUT",headers:{"Content-Type":"application/json","Authorization":"Basic"+Buffer.from(`anystring:${key}`).toString("base64"),},body:JSON.stringify({email_address:email,status_if_new:doubleOpt?"pending":"subscribed",}),timeoutMs:12_000,});constresp:any=awaitsafeJson(r);if(r.ok){returnres.status(200).json({ok:true,message:doubleOpt?"Checkyouremailtoconfirmyoursubscription.":"You'resubscribed.Welcome!",});}constdetail=String(resp?.title||resp?.detail||"");if(/exists|already/i.test(detail)){returnres.status(200).json({ok:true,message:"You'realreadysubscribed."});}returnres.status(r.status||500).json({ok:false,message:detail||"Mailchimperror"});}//---Unknown/missingproviderreturnres.status(500).json({ok:false,message:"EMAIL_PROVIDERmustbe'buttondown'or'mailchimp'"});}catch(err:any){returnres.status(500).json({ok:false,message:"Unexpectedservererror",});}}/*----------------helpers----------------*/function safeParse(s:string):unknown{try{returnJSON.parse(s);}catch{return{};}}asyncfunctionsafeJson(r:Response){try{returnawaitr.json();}catch{return{};}}asyncfunctionfetchWithTimeout(input:RequestInfo|URL,init:RequestInit&{timeoutMs?:number}={}){const{timeoutMs=10_000,...rest}=init;constcontroller=newAbortController();constt=setTimeout(()=>controller.abort(),timeoutMs);try{returnawaitfetch(inputasany,{...rest,signal:controller.signal}asany);}finally{clearTimeout(t);}}function firstErrorString(obj:any):string|undefined{if(!obj||typeofobj!=="object")return;for(constvofObject.values(obj)){if(Array.isArray(v)&&v.length&&typeofv[0]==="string")returnv[0];if(typeofv==="string")returnv;}}function safeString(v:any):string{returntypeofv==="string"?v:"";}function isPydanticArray(x:any):boolean{returnArray.isArray(x)&&x.every(e=>e&&typeofe==="object"&&"loc"ine&&"msg"ine);}

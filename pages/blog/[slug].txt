import * as React from "react";
import type { GetStaticPaths, GetStaticProps, NextPage } from "next";
import Head from "next/head";
import Layout from "@/components/Layout";
import { getPublishedPosts } from "@/lib/contentlayer-helper";
import { serialize } from "next-mdx-remote/serialize";
import remarkGfm from "remark-gfm";
import rehypeSlug from "rehype-slug";
import rehypeAutolinkHeadings from "rehype-autolink-headings";
import mdxComponents from "@/components/mdx-components";
import SafeMDXRemote from "@/components/SafeMDXRemote";

type Props = { post: any; source: any };

const SITE = "https://www.abrahamoflondon.org";

function slugFromUrl(url?: string): string | null {
  if (!url) return null;
  const parts = url.split("/").filter(Boolean);
  return parts[parts.length - 1] ?? null;
}

export const getStaticPaths: GetStaticPaths = async () => {
  const posts = getPublishedPosts();

  const paths = posts
    .map((post: any) => {
      const slug = slugFromUrl(post.url);
      return slug ? { params: { slug } } : null;
    })
    .filter(Boolean) as { params: { slug: string } }[];

  return { paths, fallback: "blocking" };
};

export const getStaticProps: GetStaticProps<Props> = async ({ params }) => {
  const slug = String(params?.slug ?? "").trim().toLowerCase();
  if (!slug) return { notFound: true };

  const posts = getPublishedPosts();
  const post = posts.find(
    (p: any) => slugFromUrl(p.url)?.toLowerCase() === slug
  );

  if (!post) return { notFound: true };

  try {
    const source = await serialize(post.body.raw, {
      mdxOptions: {
        remarkPlugins: [remarkGfm],
        rehypePlugins: [
          rehypeSlug,
          [rehypeAutolinkHeadings, { behavior: "wrap" }],
        ],
      },
    });

    return { props: { post, source }, revalidate: 1800 };
  } catch (err) {
    console.error(`‚ùå MDX Error [Post: ${slug}]`, err);
    const fallbackSource = await serialize(
      "Content is being prepared for the vault."
    );
    return { props: { post, source: fallbackSource }, revalidate: 1800 };
  }
};

const PostPage: NextPage<Props> = ({ post, source }) => {
  const title = post.title ?? "Essay";
  const canonicalUrl = `${SITE}${post.url}`;

  return (
    <Layout
      title={title}
      description={post.excerpt ?? ""}
      canonicalUrl={canonicalUrl}
      ogType="article"
      ogImage={post.coverImage ?? undefined}
    >
      <Head>
        <link rel="canonical" href={canonicalUrl} />
      </Head>

      <main className="mx-auto max-w-3xl px-6 py-12 sm:py-16 lg:py-24">
        <header className="mb-10 space-y-4 border-b border-gold/10 pb-10">
          <p className="text-[10px] font-bold uppercase tracking-[0.3em] text-gold">
            Insight & Reflection
          </p>
          <h1 className="font-serif text-3xl font-semibold text-cream sm:text-4xl lg:text-5xl">
            {title}
          </h1>
          <div className="flex items-center gap-4 text-[11px] font-mono uppercase tracking-widest text-gray-500">
            {post.date && (
              <span>
                {new Date(post.date).toLocaleDateString("en-GB", {
                  day: "numeric",
                  month: "short",
                  year: "numeric",
                })}
              </span>
            )}
            {post.author && (
              <>
                <span className="h-1 w-1 rounded-full bg-gold/30" />
                <span>{post.author}</span>
              </>
            )}
          </div>
        </header>

        <article className="prose prose-invert prose-gold max-w-none prose-headings:font-serif prose-p:text-gray-300">
          <SafeMDXRemote source={source} components={mdxComponents} />
        </article>
      </main>
    </Layout>
  );
};

export default PostPage;
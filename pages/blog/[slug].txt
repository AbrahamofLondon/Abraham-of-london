// pages/blog/[slug].tsx
import * as React from "react";
import type { GetStaticPaths, GetStaticProps, NextPage } from "next";
import Head from "next/head";
import Link from "next/link";
import { serialize } from "next-mdx-remote/serialize";
import type { MDXRemoteSerializeResult } from "next-mdx-remote";

import Layout from "@/components/Layout";
import mdxComponents from "@/components/mdx-components";
import SafeMDXRemote from "@/components/SafeMDXRemote";

import remarkGfm from "remark-gfm";
import rehypeSlug from "rehype-slug";
import rehypeAutolinkHeadings from "rehype-autolink-headings";

import { allPosts, normalizeSlug, isDraft } from "@/lib/contentlayer-helper";

type Props = {
  title: string;
  excerpt?: string | null;
  description?: string | null;
  coverImage?: string | null;
  date?: string | null;
  readTime?: string | null;
  source: MDXRemoteSerializeResult;
  canonicalUrl: string;
};

const SITE = "https://www.abrahamoflondon.org";

const BlogSlugPage: NextPage<Props> = ({
  title,
  excerpt,
  description,
  coverImage,
  source,
  canonicalUrl,
}) => {
  const desc = description || excerpt || "";

  return (
    <Layout
      title={title}
      description={desc}
      canonicalUrl={canonicalUrl}
      ogImage={coverImage ?? undefined}
      ogType="article"
    >
      <Head>
        <link rel="canonical" href={canonicalUrl} />
      </Head>

      <main className="mx-auto max-w-4xl px-4 py-14">
        <Link href="/blog" className="text-sm text-gold hover:underline">
          ‚Üê Back to Essays
        </Link>

        <h1 className="mt-4 font-serif text-3xl sm:text-4xl font-semibold text-cream">
          {title}
        </h1>

        {excerpt ? <p className="mt-4 text-gray-300">{excerpt}</p> : null}

        <article className="prose prose-invert max-w-none prose-headings:font-serif prose-a:text-gold mt-10">
          <SafeMDXRemote source={source} components={mdxComponents} />
        </article>
      </main>
    </Layout>
  );
};

export const getStaticPaths: GetStaticPaths = async () => {
  const paths = allPosts
    .filter((p: any) => !isDraft(p))
    .map((p: any) => normalizeSlug(p))
    .filter(Boolean)
    .map((slug: string) => ({ params: { slug } }));

  return { paths, fallback: "blocking" };
};

export const getStaticProps: GetStaticProps<Props> = async ({ params }) => {
  const slug = String(params?.slug ?? "").trim().toLowerCase();
  if (!slug) return { notFound: true };

  const post = allPosts.find((p: any) => !isDraft(p) && normalizeSlug(p) === slug);
  if (!post) return { notFound: true };

  const raw = String(post?.body?.raw ?? "");

  let source: MDXRemoteSerializeResult;
  try {
    source = await serialize(raw, {
      mdxOptions: {
        remarkPlugins: [remarkGfm],
        rehypePlugins: [rehypeSlug, [rehypeAutolinkHeadings, { behavior: "wrap" }]],
      },
    });
  } catch (e) {
    console.error(`[blog serialize failed] slug=${slug}`, e);
    source = await serialize("Content is being prepared.");
  }

  const canonicalUrl = `${SITE}/blog/${slug}`;

  return {
    props: {
      title: String(post.title ?? "Essay"),
      excerpt: post.excerpt ?? null,
      description: post.description ?? null,
      coverImage: post.coverImage ?? null,
      date: post.date ?? null,
      readTime: post.readTime ?? null,
      source,
      canonicalUrl,
    },
    revalidate: 3600,
  };
};

export default BlogSlugPage;
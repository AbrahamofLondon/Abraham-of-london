// pages/[slug].tsx
import * as React from "react";
import type { GetStaticPaths, GetStaticProps, NextPage } from "next";
import Head from "next/head";
import { useRouter } from "next/router";
import Image from "next/image";
import {
  MDXRemote,
  type MDXRemoteSerializeResult,
} from "next-mdx-remote";
import { serialize } from "next-mdx-remote/serialize";
import {
  ArrowRight,
  Clock,
  Calendar,
  Tag,
  Share2,
  Bookmark,
  Heart,
  MessageCircle,
  ArrowUpRight,
  Eye,
  Layers,
  Sparkles,
  ChevronRight
} from "lucide-react";
import { motion } from "framer-motion";

import Layout from "@/components/Layout";
import mdxComponents from "@/components/mdx-components";

import { getAllPosts, getPostBySlug } from "@/lib/content";
import type { Post } from "contentlayer/generated";

type PageMeta = {
  slug: string;
  title: string;
  subtitle?: string | null;
  excerpt?: string | null;
  date?: string | null;
  coverImage?: string | null;
  readTime?: string | null;
  tags?: string[];
};

type PageProps = {
  meta: PageMeta;
  source: MDXRemoteSerializeResult;
};

/* -------------------------------------------------------------------------- */
/* PREMIUM UI COMPONENTS                                                      */
/* -------------------------------------------------------------------------- */

const GlassPanel: React.FC<{ 
  children: React.ReactNode; 
  className?: string; 
  hover?: boolean;
  glow?: boolean;
}> = ({ children, className = "", hover = true, glow = false }) => (
  <div className={`
    relative overflow-hidden rounded-2xl 
    bg-white/[0.08] backdrop-blur-xl
    border border-white/10
    shadow-2xl shadow-black/40
    ${hover ? "transition-all duration-700 hover:scale-[1.02] hover:shadow-3xl hover:shadow-black/60 hover:border-white/20" : ""}
    ${glow ? "after:pointer-events-none after:absolute after:inset-0 after:bg-gradient-to-br after:from-amber-500/5 after:via-transparent after:to-amber-500/5" : ""}
    ${className}
  `}>
    <div className="relative z-10 h-full">{children}</div>
  </div>
);

const StatBadge: React.FC<{ 
  icon: React.ReactNode; 
  label: string; 
  value: string | number;
}> = ({ icon, label, value }) => (
  <div className="flex flex-col items-center rounded-2xl bg-white/5 p-4 backdrop-blur-sm">
    <div className="mb-3 rounded-full bg-gradient-to-br from-amber-500/20 to-amber-600/20 p-3">
      {icon}
    </div>
    <div className="text-2xl font-bold text-white">{value}</div>
    <div className="mt-1 text-xs font-medium text-gray-400">{label}</div>
  </div>
);

const TagPill: React.FC<{ tag: string; isActive?: boolean }> = ({ tag, isActive = false }) => (
  <span className={`
    inline-flex items-center gap-1.5 rounded-full border px-3 py-1.5 text-xs font-medium
    ${isActive 
      ? 'border-amber-500/50 bg-amber-500/10 text-amber-300' 
      : 'border-white/10 bg-white/5 text-gray-300 hover:bg-white/10 hover:text-white'
    }
    transition-all duration-300 hover:scale-105
  `}>
    <Tag className="h-3 w-3" />
    {tag}
  </span>
);

const ArticleActionButton: React.FC<{
  icon: React.ReactNode;
  label: string;
  onClick?: () => void;
  variant?: 'default' | 'primary' | 'ghost';
}> = ({ icon, label, onClick, variant = 'default' }) => {
  const baseClasses = "flex items-center gap-3 rounded-xl px-4 py-3 font-medium transition-all duration-300";
  
  const variants = {
    default: "border border-white/10 bg-white/5 text-gray-300 hover:bg-white/10 hover:text-white hover:border-white/20",
    primary: "bg-gradient-to-r from-amber-500 to-amber-600 text-white hover:shadow-lg hover:shadow-amber-500/25 hover:scale-105",
    ghost: "text-gray-400 hover:text-white hover:bg-white/5"
  };

  return (
    <button
      onClick={onClick}
      className={`${baseClasses} ${variants[variant]} transform hover:-translate-y-0.5`}
    >
      {icon}
      <span>{label}</span>
    </button>
  );
};

/* -------------------------------------------------------------------------- */
/* ARTICLE HERO (Replaces ArticleHero component)                              */
/* -------------------------------------------------------------------------- */

const ArticleHero: React.FC<{
  title: string;
  subtitle?: string;
  date?: string;
  tags?: string[];
  readTime?: string;
  coverImage?: string;
  coverAspect?: "wide" | "tall" | "square";
  coverFit?: "cover" | "contain";
}> = ({ 
  title, 
  subtitle, 
  date, 
  tags = [], 
  readTime, 
  coverImage,
  coverAspect = "wide",
  coverFit = "cover"
}) => {
  const [isBookmarked, setIsBookmarked] = React.useState(false);
  const [isLiked, setIsLiked] = React.useState(false);

  const formatDate = (dateString?: string) => {
    if (!dateString) return "";
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      month: 'long', 
      day: 'numeric',
      year: 'numeric' 
    });
  };

  const aspectClasses = {
    wide: "aspect-video",
    tall: "aspect-[3/4]",
    square: "aspect-square"
  };

  const fitClasses = {
    cover: "object-cover",
    contain: "object-contain"
  };

  return (
    <section className="relative overflow-hidden">
      {/* Background Effects */}
      <div className="absolute inset-0 bg-gradient-to-b from-black via-black/80 to-black" />
      <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-amber-500/10 via-transparent to-transparent" />
      
      <div className="relative z-10">
        {/* Cover Image */}
        {coverImage && (
          <div className="relative mb-8 overflow-hidden rounded-3xl">
            <div className={`relative ${aspectClasses[coverAspect]} w-full overflow-hidden`}>
              <Image
                src={coverImage}
                alt={title}
                fill
                className={`${fitClasses[coverFit]} transition-transform duration-1000 hover:scale-105`}
                priority
              />
              <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent" />
              
              {/* Corner Accents */}
              <div className="absolute top-6 left-6 w-16 h-16 border-t border-l border-amber-400/30" />
              <div className="absolute top-6 right-6 w-16 h-16 border-t border-r border-amber-400/30" />
              <div className="absolute bottom-6 left-6 w-16 h-16 border-b border-l border-amber-400/30" />
              <div className="absolute bottom-6 right-6 w-16 h-16 border-b border-r border-amber-400/30" />
            </div>
          </div>
        )}

        {/* Article Header */}
        <div className="space-y-6">
          {/* Meta Badges */}
          <div className="flex flex-wrap items-center gap-3">
            <span className="inline-flex items-center gap-2 rounded-full border border-amber-500/30 bg-amber-500/10 px-3 py-1.5 text-xs font-semibold text-amber-300">
              <Sparkles className="h-3 w-3" />
              Strategic Essay
            </span>
            {tags.slice(0, 2).map((tag) => (
              <TagPill key={tag} tag={tag} />
            ))}
          </div>

          {/* Title & Subtitle */}
          <div className="space-y-4">
            <h1 className="font-serif text-4xl leading-tight text-white md:text-5xl lg:text-6xl">
              {title}
            </h1>
            {subtitle && (
              <p className="text-xl leading-relaxed text-gray-300 md:text-2xl">
                {subtitle}
              </p>
            )}
          </div>

          {/* Stats & Actions */}
          <div className="flex flex-col gap-6 pt-6 lg:flex-row lg:items-center lg:justify-between">
            {/* Reading Stats */}
            <div className="flex flex-wrap items-center gap-4">
              <div className="flex items-center gap-2 text-sm text-gray-400">
                <Calendar className="h-4 w-4" />
                <time dateTime={date}>{formatDate(date)}</time>
              </div>
              {readTime && (
                <div className="flex items-center gap-2 text-sm text-gray-400">
                  <Clock className="h-4 w-4" />
                  <span>{readTime}</span>
                </div>
              )}
              <div className="flex items-center gap-2 text-sm text-gray-400">
                <Eye className="h-4 w-4" />
                <span>2.4k views</span>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex flex-wrap items-center gap-3">
              <button
                onClick={() => setIsBookmarked(!isBookmarked)}
                className={`rounded-full p-3 transition-all ${
                  isBookmarked 
                    ? 'bg-amber-500/20 text-amber-400' 
                    : 'bg-white/5 text-gray-400 hover:bg-white/10 hover:text-amber-400'
                }`}
              >
                <Bookmark className={`h-5 w-5 ${isBookmarked ? 'fill-current' : ''}`} />
              </button>
              <button
                onClick={() => setIsLiked(!isLiked)}
                className={`rounded-full p-3 transition-all ${
                  isLiked 
                    ? 'bg-rose-500/20 text-rose-400' 
                    : 'bg-white/5 text-gray-400 hover:bg-white/10 hover:text-rose-400'
                }`}
              >
                <Heart className={`h-5 w-5 ${isLiked ? 'fill-current' : ''}`} />
              </button>
              <button className="rounded-full bg-white/5 p-3 text-gray-400 transition-all hover:bg-white/10 hover:text-amber-400">
                <Share2 className="h-5 w-5" />
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  );
};

/* -------------------------------------------------------------------------- */
/* SIDEBAR COMPONENTS                                                         */
/* -------------------------------------------------------------------------- */

const TableOfContents: React.FC<{ headings?: Array<{ level: number; text: string; id: string }> }> = ({ headings = [] }) => {
  if (headings.length === 0) {
    return (
      <GlassPanel className="p-6">
        <div className="mb-4 flex items-center gap-3">
          <Layers className="h-5 w-5 text-amber-400" />
          <h3 className="font-semibold text-white">Table of Contents</h3>
        </div>
        <p className="text-sm text-gray-400">No headings available</p>
      </GlassPanel>
    );
  }

  return (
    <GlassPanel className="sticky top-24 p-6">
      <div className="mb-6">
        <div className="mb-4 flex items-center gap-3">
          <Layers className="h-5 w-5 text-amber-400" />
          <h3 className="font-semibold text-white">In this essay</h3>
        </div>
        <nav className="space-y-2">
          {headings.map((heading) => (
            <a
              key={heading.id}
              href={`#${heading.id}`}
              className="group flex items-start gap-2 rounded-lg px-3 py-2 text-sm text-gray-400 transition-all hover:bg-white/5 hover:text-white"
              style={{ marginLeft: `${(heading.level - 2) * 12}px` }}
            >
              <ChevronRight className="mt-0.5 h-3 w-3 flex-shrink-0 opacity-0 transition-all group-hover:opacity-100 group-hover:text-amber-400" />
              <span className="group-hover:text-amber-300">{heading.text}</span>
            </a>
          ))}
        </nav>
      </div>
      
      <div className="border-t border-white/10 pt-6">
        <p className="text-xs text-gray-400">
          {headings.length} sections â€¢ {Math.ceil(headings.length * 1.5)} min read
        </p>
      </div>
    </GlassPanel>
  );
};

const RelatedContent: React.FC = () => {
  const relatedItems = [
    { title: "The Architecture of Human Purpose", category: "Book", readTime: "45 min" },
    { title: "When Gods Sovereignty Collides", category: "Essay", readTime: "12 min" },
    { title: "Foundations of Kingdom Strategy", category: "Tool", readTime: "8 min" },
  ];

  return (
    <GlassPanel className="p-6">
      <h3 className="mb-4 font-semibold text-white">Related Content</h3>
      <div className="space-y-4">
        {relatedItems.map((item, index) => (
          <a
            key={index}
            href="#"
            className="group block rounded-xl border border-white/5 p-4 transition-all hover:border-white/10 hover:bg-white/5"
          >
            <div className="flex items-start justify-between">
              <div>
                <span className="mb-1 inline-block text-xs font-medium text-amber-400">
                  {item.category}
                </span>
                <h4 className="text-sm font-medium text-white group-hover:text-amber-300">
                  {item.title}
                </h4>
              </div>
              <ArrowUpRight className="h-4 w-4 text-gray-400 transition-transform group-hover:translate-x-0.5 group-hover:-translate-y-0.5 group-hover:text-amber-400" />
            </div>
            <div className="mt-3 flex items-center gap-2 text-xs text-gray-400">
              <Clock className="h-3 w-3" />
              <span>{item.readTime}</span>
            </div>
          </a>
        ))}
      </div>
    </GlassPanel>
  );
};

const ReadingStats: React.FC = () => {
  const stats = [
    { label: "Words", value: "3,248" },
    { label: "Characters", value: "18,742" },
    { label: "Reading Level", value: "Advanced" },
    { label: "Sentences", value: "184" },
  ];

  return (
    <GlassPanel className="p-6">
      <h3 className="mb-6 font-semibold text-white">Reading Statistics</h3>
      <div className="grid grid-cols-2 gap-4">
        {stats.map((stat, index) => (
          <StatBadge
            key={index}
            icon={index === 0 ? "ðŸ“" : index === 1 ? "ðŸ”¤" : index === 2 ? "ðŸŽ¯" : "ðŸ“Š"}
            label={stat.label}
            value={stat.value}
          />
        ))}
      </div>
    </GlassPanel>
  );
};

/* -------------------------------------------------------------------------- */
/* ARTICLE CONTENT COMPONENTS                                                 */
/* -------------------------------------------------------------------------- */

const CallToAction: React.FC = () => {
  return (
    <GlassPanel glow className="my-12 overflow-hidden">
      <div className="p-8 text-center">
        <div className="mx-auto mb-6 flex h-16 w-16 items-center justify-center rounded-full bg-gradient-to-br from-amber-500/20 to-amber-600/20">
          <MessageCircle className="h-8 w-8 text-amber-400" />
        </div>
        <h3 className="mb-4 font-serif text-2xl font-bold text-white">
          What did this stir in you?
        </h3>
        <p className="mx-auto mb-8 max-w-md text-gray-300">
          Your perspective matters. Share your thoughts, questions, or how this essay landed with you.
        </p>
        <div className="flex flex-col gap-3 sm:flex-row sm:justify-center">
          <ArticleActionButton
            icon={<MessageCircle className="h-5 w-5" />}
            label="Join the conversation"
            variant="primary"
          />
          <ArticleActionButton
            icon={<Share2 className="h-5 w-5" />}
            label="Share with someone"
            variant="default"
          />
        </div>
      </div>
    </GlassPanel>
  );
};

/* -------------------------------------------------------------------------- */
/* MAIN PAGE COMPONENT                                                        */
/* -------------------------------------------------------------------------- */

const EssayPage: NextPage<PageProps> = ({ meta, source }) => {
  const router = useRouter();
  const [activeSection, setActiveSection] = React.useState<string>("");

  if (router.isFallback) {
    return (
      <Layout title="Loadingâ€¦">
        <div className="flex min-h-screen items-center justify-center bg-black">
          <div className="text-center">
            <div className="mb-4 h-12 w-12 animate-spin rounded-full border-4 border-amber-500/30 border-t-amber-500" />
            <p className="text-amber-400">Loading essayâ€¦</p>
          </div>
        </div>
      </Layout>
    );
  }

  return (
    <Layout title={meta.title} description={meta.excerpt ?? undefined}>
      <Head>
        <link
          rel="canonical"
          href={`https://www.abrahamoflondon.org/${meta.slug}`}
        />
      </Head>

      <div className="relative min-h-screen overflow-hidden bg-black text-white">
        {/* Background Effects */}
        <div className="fixed inset-0 -z-10">
          <div className="absolute inset-0 bg-gradient-to-br from-[#050608] via-[#050814] to-[#020617]" />
          <div className="absolute inset-0 overflow-hidden">
            <div className="absolute top-1/4 left-1/4 h-80 w-80 rounded-full bg-purple-500/8 blur-3xl" />
            <div className="absolute top-1/3 right-1/4 h-72 w-72 rounded-full bg-cyan-500/8 blur-3xl" />
          </div>
        </div>

        <main className="relative">
          {/* Hero Section */}
          <section className="relative px-4 pt-8 pb-12 md:pt-12">
            <div className="mx-auto max-w-6xl">
              <ArticleHero
                title={meta.title}
                subtitle={meta.subtitle ?? undefined}
                date={meta.date ?? undefined}
                tags={meta.tags}
                readTime={meta.readTime ?? undefined}
                coverImage={meta.coverImage ?? undefined}
                coverAspect="wide"
                coverFit="cover"
              />
            </div>
          </section>

          {/* Main Content */}
          <section className="relative px-4 pb-20">
            <div className="mx-auto max-w-7xl">
              <div className="grid gap-8 lg:grid-cols-4">
                {/* Sidebar */}
                <div className="lg:col-span-1">
                  <div className="space-y-6">
                    <TableOfContents />
                    <ReadingStats />
                    <RelatedContent />
                  </div>
                </div>

                {/* Article Content */}
                <div className="lg:col-span-3">
                  <GlassPanel className="overflow-hidden">
                    <div className="p-8 md:p-12">
                      <article className="prose prose-invert prose-lg max-w-none">
                        <style jsx global>{`
                          .prose {
                            --tw-prose-body: theme('colors.gray.300');
                            --tw-prose-headings: theme('colors.white');
                            --tw-prose-lead: theme('colors.amber.400');
                            --tw-prose-links: theme('colors.amber.400');
                            --tw-prose-bold: theme('colors.white');
                            --tw-prose-counters: theme('colors.amber.400');
                            --tw-prose-bullets: theme('colors.gray.600');
                            --tw-prose-hr: theme('colors.gray.700');
                            --tw-prose-quotes: theme('colors.gray.300');
                            --tw-prose-quote-borders: theme('colors.amber.500');
                            --tw-prose-captions: theme('colors.gray.500');
                            --tw-prose-code: theme('colors.amber.300');
                            --tw-prose-pre-code: theme('colors.gray.800');
                            --tw-prose-pre-bg: theme('colors.gray.900');
                            --tw-prose-th-borders: theme('colors.gray.700');
                            --tw-prose-td-borders: theme('colors.gray.800');
                          }

                          .prose h1, .prose h2, .prose h3, .prose h4 {
                            font-family: var(--font-serif);
                            font-weight: 700;
                            letter-spacing: -0.01em;
                          }

                          .prose h2 {
                            position: relative;
                            padding-left: 1.5rem;
                          }

                          .prose h2:before {
                            content: '';
                            position: absolute;
                            left: 0;
                            top: 0.5em;
                            height: 1.5em;
                            width: 3px;
                            background: linear-gradient(to bottom, theme('colors.amber.500'), theme('colors.amber.600'));
                            border-radius: 3px;
                          }

                          .prose a {
                            text-decoration: none;
                            border-bottom: 1px solid theme('colors.amber.400/30');
                            transition: all 0.3s ease;
                          }

                          .prose a:hover {
                            color: theme('colors.amber.300');
                            border-bottom-color: theme('colors.amber.400');
                          }

                          .prose blockquote {
                            border-left-width: 4px;
                            border-left-color: theme('colors.amber.500/50');
                            background: linear-gradient(to right, theme('colors.amber.500/5'), transparent);
                            padding-left: 2rem;
                            font-style: italic;
                          }

                          .prose code {
                            background: theme('colors.gray.900');
                            padding: 0.2em 0.4em;
                            border-radius: 0.375rem;
                            font-size: 0.875em;
                          }

                          .prose pre {
                            background: theme('colors.gray.900');
                            border: 1px solid theme('colors.gray.800');
                            border-radius: 0.75rem;
                            padding: 1.5rem;
                            overflow-x: auto;
                          }

                          .prose img {
                            border-radius: 1rem;
                            border: 1px solid theme('colors.gray.800');
                          }
                        `}</style>
                        
                        <MDXRemote {...source} components={mdxComponents} />
                      </article>

                      {/* Tags */}
                      {meta.tags && meta.tags.length > 0 && (
                        <div className="mt-12 border-t border-white/10 pt-8">
                          <div className="flex flex-wrap items-center gap-3">
                            <span className="text-sm font-medium text-gray-400">Topics:</span>
                            {meta.tags.map((tag) => (
                              <TagPill key={tag} tag={tag} />
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </GlassPanel>

                  {/* Call to Action */}
                  <CallToAction />

                  {/* Comments Section */}
                  <GlassPanel className="p-8">
                    <div className="mb-8 flex items-center justify-between">
                      <div>
                        <h3 className="font-serif text-2xl font-bold text-white">Conversation</h3>
                        <p className="text-gray-400">Join the discussion with other readers</p>
                      </div>
                      <ArticleActionButton
                        icon={<MessageCircle className="h-5 w-5" />}
                        label="Add comment"
                        variant="primary"
                      />
                    </div>
                    
                    {/* Comments Component */}
                    <div className="space-y-6">
                      {/* Placeholder for actual comments */}
                      <div className="rounded-xl border border-white/10 p-6">
                        <div className="mb-4 flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <div className="h-10 w-10 rounded-full bg-gradient-to-br from-amber-500/20 to-amber-600/20" />
                            <div>
                              <div className="font-medium text-white">Michael</div>
                              <div className="text-sm text-gray-400">2 hours ago</div>
                            </div>
                          </div>
                          <button className="rounded-lg bg-white/5 px-3 py-1.5 text-sm text-gray-400 hover:text-white">
                            Reply
                          </button>
                        </div>
                        <p className="text-gray-300">
                          "This essay reframed how I think about legacy. The section on purposeful work particularly resonated."
                        </p>
                      </div>
                    </div>
                  </GlassPanel>
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </Layout>
  );
};

export default EssayPage;

export const getStaticPaths: GetStaticPaths = async () => {
  const posts = getAllPosts();
  return {
    paths: posts.map((post) => ({ params: { slug: post.slug } })),
    fallback: false,
  };
};

export const getStaticProps: GetStaticProps<PageProps> = async (context) => {
  const slug = context.params?.slug as string;
  const post = getPostBySlug(slug);

  if (!post) return { notFound: true };

  const mdxSource = await serialize(post.body.raw, {
    mdxOptions: {
      remarkPlugins: [],
      rehypePlugins: [],
    },
  });

  const meta: PageMeta = {
    slug: post.slug,
    title: post.title,
    subtitle: (post as Post & { subtitle?: string }).subtitle ?? null,
    excerpt: post.excerpt ?? null,
    date: post.date ?? null,
    coverImage: post.coverImage ?? null,
    readTime: (post as any).readTime ?? null,
    tags: post.tags ?? [],
  };

  return {
    props: {
      meta,
      source: mdxSource,
    },
    revalidate: 3600,
  };
};
import type { GetStaticPaths, GetStaticProps, NextPage } from "next";
import ContentlayerDocPage from "@/components/ContentlayerDocPage";
import {
  assertContentlayerHasDocs,
  findDocByKindAndSlug,
  getDocHref,
  getPublishedPosts,
} from "@/lib/contentlayer-helper";

type Props = { doc: any; canonicalPath: string };

const BlogPostPage: NextPage<Props> = ({ doc, canonicalPath }) => {
  return (
    <ContentlayerDocPage
      doc={doc}
      canonicalPath={canonicalPath}
      backHref="/blog"
      label="Essays"
    />
  );
};

export const getStaticPaths: GetStaticPaths = async () => {
  assertContentlayerHasDocs("pages/blog/[slug].tsx getStaticPaths");

  const posts = getPublishedPosts();

  // IMPORTANT: slug param must be ONLY the tail segment, not "/blog/..."
  const paths = posts
    .map((p) => getDocHref(p))
    .filter((href) => href.startsWith("/blog/"))
    .map((href) => ({ params: { slug: href.replace("/blog/", "") } }));

  return { paths, fallback: "blocking" };
};

export const getStaticProps: GetStaticProps<Props> = async ({ params }) => {
  assertContentlayerHasDocs("pages/blog/[slug].tsx getStaticProps");

  const slug = String(params?.slug ?? "").trim().toLowerCase();
  if (!slug) return { notFound: true };

  const doc = findDocByKindAndSlug("post", slug);
  if (!doc) return { notFound: true };

  return {
    props: { doc, canonicalPath: getDocHref(doc) },
    revalidate: 3600,
  };
};

export default BlogPostPage;
import * as React from "react";
import type {
  GetStaticPaths,
  GetStaticProps,
  InferGetStaticPropsType,
  NextPage,
} from "next";
import Head from "next/head";
import Layout from "@/components/Layout";

import { getPublishedPosts } from "@/lib/contentlayer-helper";

import { MDXRemote, type MDXRemoteSerializeResult } from "next-mdx-remote";
import { serialize } from "next-mdx-remote/serialize";
import remarkGfm from "remark-gfm";
import rehypeSlug from "rehype-slug";
import rehypeAutolinkHeadings from "rehype-autolink-headings";
import mdxComponents from "@/components/mdx-components";

type Props = {
  post: any;
  source: MDXRemoteSerializeResult;
};

export const getStaticPaths: GetStaticPaths = async () => {
  const posts = getPublishedPosts();

  const paths = posts.map((post) => ({
    params: {
      slug:
        post.slug ??
        post._raw?.flattenedPath?.split("/").pop() ??
        "",
    },
  }));

  return { paths, fallback: "blocking" };
};

export const getStaticProps: GetStaticProps<Props> = async ({ params }) => {
  const slug = params?.slug as string;
  if (!slug) return { notFound: true };

  const posts = getPublishedPosts();

  const post = posts.find((p) => {
    const s =
      p.slug ?? p._raw?.flattenedPath?.split("/").pop();
    return s === slug;
  });

  if (!post) return { notFound: true };

  const raw = post.body?.raw ?? "";

  const source = await serialize(raw, {
    mdxOptions: {
      remarkPlugins: [remarkGfm],
      rehypePlugins: [
        rehypeSlug,
        [rehypeAutolinkHeadings, { behavior: "wrap" }],
      ],
    },
  });

  return {
    props: { post, source },
    revalidate: 1800,
  };
};

const BlogPostPage: NextPage<
  InferGetStaticPropsType<typeof getStaticProps>
> = ({ post, source }) => {
  return (
    <Layout title={post.title}>
      <Head>
        {post.excerpt && (
          <meta name="description" content={post.excerpt} />
        )}
      </Head>

      <main className="mx-auto max-w-3xl px-4 py-12">
        <h1 className="font-serif text-3xl text-cream">
          {post.title}
        </h1>

        {post.excerpt && (
          <p className="mt-3 text-gray-300">
            {post.excerpt}
          </p>
        )}

        <article className="prose prose-invert mt-8 max-w-none">
          <MDXRemote {...source} components={mdxComponents} />
        </article>
      </main>
    </Layout>
  );
};

export default BlogPostPage;
/* prisma/schema.prisma â€” PRODUCTION HARDENED SCHEMA [VERSION 2.7.0] */

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. ASSET AUDIT SYSTEM
model DownloadAuditEvent {
  id            String   @id @default(cuid())
  slug          String   // The Brief ID
  contentType   String   @default("download")
  eventType     String   @default("download")
  memberId      String?
  fileName      String?
  fileSize      BigInt?
  fileHash      String?  
  userId        String?
  email         String?
  emailHash     String?  
  sessionId     String?
  deviceId      String?
  userAgent     String?
  ipAddress     String?
  ipHash        String?  
  countryCode   String?
  region        String?
  city          String?
  referrer      String?
  
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  
  statusCode    Int?
  latencyMs     Int?
  success       Boolean  @default(true)
  errorCode     String?
  errorDetail   String?
  
  createdAt     DateTime @default(now())
  processedAt   DateTime?

  member        InnerCircleMember? @relation(fields: [memberId], references: [id], onDelete: SetNull)

  @@index([slug])
  @@index([createdAt])
  @@index([memberId])
}

// 2. CORE IDENTITY & MEMBERSHIP
model InnerCircleMember {
  id              String   @id @default(cuid())
  emailHash       String   @unique
  emailHashPrefix String
  name            String?
  email           String?  
  status          String   @default("active") 
  tier            String   @default("standard") 
  role            String   @default("MEMBER")   
  
  loginCount      Int      @default(0)
  lastSeenAt      DateTime @default(now())
  lastIp          String?
  flags           String?  
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  downloadEvents    DownloadAuditEvent[]
  shortInteractions ShortInteraction[]
  keys              InnerCircleKey[]
  sessions          Session[]

  @@index([status])
  @@index([tier])
}

// 3. SECURITY & ACCESS CONTROL
model InnerCircleKey {
  id            String   @id @default(cuid())
  memberId      String
  keyHash       String   @unique
  keySuffix     String   
  status        String   @default("active")
  keyType       String?  @default("standard") 
  totalUnlocks  Int      @default(0)
  
  createdAt     DateTime @default(now())
  lastUsedAt    DateTime?
  lastIp        String?
  expiresAt     DateTime?
  revokedAt     DateTime?
  revokedReason String?
  metadata      String?

  member        InnerCircleMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
}

// 4. CONTENT & ENGAGEMENT ENGINE
model ContentMetadata {
  id                String   @id @default(cuid())
  slug              String   @unique
  title             String
  contentType       String   
  version           String   @default("1.0.0")
  classification    String   @default("UNCLASSIFIED") // Prepared for scaling security
  
  totalDownloads    Int      @default(0)
  uniqueDownloaders Int      @default(0)
  viewCount         Int      @default(0)
  shareCount        Int      @default(0)
  likeCount         Int      @default(0)
  
  tags              String?
  metadata          String?  
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  shortInteractions ShortInteraction[]

  @@index([contentType])
  @@index([classification])
}

model ShortInteraction {
  id        String   @id @default(cuid())
  type      String   // e.g., "LIKE", "SHARE", "BOOKMARK"
  createdAt DateTime @default(now())
  
  memberId  String
  member    InnerCircleMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  contentId String
  content   ContentMetadata   @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([contentId])
  @@index([type])
}

// 5. SYSTEM STABILITY
model ApiRateLimit {
  id           Int      @id @default(autoincrement())
  identifier   String   
  bucketType   String   
  requestCount Int      @default(0)
  windowStart  DateTime
  windowEnd    DateTime
  lastRequest  DateTime

  @@unique([identifier, bucketType, windowStart])
}

model SystemAuditLog {
  id           String   @id @default(cuid())
  actorType    String   @default("system") 
  actorId      String?
  actorEmail   String
  action       String   
  resourceType String   @default("system")
  resourceId   String
  status       String   @default("success")
  severity     String   @default("info") 
  metadata     String  @db.Text
  createdAt    DateTime @default(now())

  @@index([action])
  @@index([createdAt])
}

model Session {
  id            String   @id @default(cuid())
  sessionId     String   @unique
  memberId      String?
  expiresAt     DateTime
  lastActivity  DateTime
  createdAt     DateTime @default(now())
  member        InnerCircleMember? @relation(fields: [memberId], references: [id], onDelete: Cascade)
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  type        String
  description String
  category    String?  @default("general")
  isPublic    Boolean  @default(false)
  updatedAt   DateTime @updatedAt
}

model MaintenanceLog {
  id          String   @id @default(cuid())
  operation   String
  status      String   @default("pending")
  startedAt   DateTime
  completedAt DateTime?
  createdAt   DateTime @default(now())
}
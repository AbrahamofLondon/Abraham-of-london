// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model DownloadAuditEvent {
  id            String   @id @default(cuid())
  slug          String
  contentType   String   @default("download")
  eventType     String   @default("download")
  memberId      String?
  fileName      String?
  fileSize      BigInt?
  fileHash      String?
  userId        String?
  email         String?
  emailHash     String?
  sessionId     String?
  deviceId      String?
  userAgent     String?
  ipAddress     String?
  ipHash        String?
  countryCode   String?
  region        String?
  city          String?
  referrer      String?
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  statusCode    Int?
  latencyMs     Int?
  success       Boolean  @default(true)
  errorCode     String?
  errorDetail   String?
  createdAt     DateTime @default(now())
  processedAt   DateTime?

  member        InnerCircleMember? @relation(fields: [memberId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([slug], name: "download_audit_events_slug_idx")
  @@index([createdAt], name: "download_audit_events_created_at_idx")
  @@index([memberId], name: "download_audit_events_member_id_idx")
  @@index([emailHash], name: "download_audit_events_email_hash_idx")
}

model ShortInteraction {
  id          Int      @id @default(autoincrement())
  shortSlug   String
  sessionId   String?
  emailHash   String?
  memberId    String?
  action      String
  subAction   String?
  metadata    String?
  userAgent   String?
  ipAddress   String?
  ipHash      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  deletedAt   DateTime?

  member      InnerCircleMember? @relation(fields: [memberId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([shortSlug], name: "short_interactions_short_slug_idx")
  @@index([memberId], name: "short_interactions_member_id_idx")
  @@index([emailHash], name: "short_interactions_email_hash_idx")
  @@index([createdAt], name: "short_interactions_created_at_idx")
}

model StrategyRoomIntake {
  id                String   @id @default(cuid())
  fullName          String
  emailHash         String
  organisation      String
  status            String
  score             Int
  decisionStatement String
  payload           String
  createdAt         DateTime @default(now())

  @@index([status], name: "strategy_room_intakes_status_idx")
  @@index([emailHash], name: "strategy_room_intakes_email_hash_idx")
}

model InnerCircleMember {
  id               String            @id @default(cuid())
  emailHash        String            @unique
  emailHashPrefix  String
  name             String?
  status           String            @default("active")
  tier             String            @default("standard")
  createdAt        DateTime          @default(now())
  lastSeenAt       DateTime          @default(now())
  lastIp           String?
  loginCount       Int               @default(0)
  email            String?
  flags            String?

  downloadEvents   DownloadAuditEvent[]
  shortInteractions ShortInteraction[]
  keys             InnerCircleKey[]
  sessions         Session[]

  @@index([status], name: "inner_circle_members_status_idx")
  @@index([tier], name: "inner_circle_members_tier_idx")
  @@index([createdAt], name: "inner_circle_members_created_at_idx")
}

model InnerCircleKey {
  id            String   @id @default(cuid())
  memberId      String
  keyHash       String   @unique
  keySuffix     String
  status        String   @default("active")
  totalUnlocks  Int      @default(0)
  createdAt     DateTime @default(now())
  lastUsedAt    DateTime?
  lastIp        String?
  expiresAt     DateTime?
  revokedAt     DateTime?
  revokedReason String?
  keyType       String?  @default("standard")
  metadata      String?

  member        InnerCircleMember @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([memberId], name: "inner_circle_keys_member_id_idx")
  @@index([status], name: "inner_circle_keys_status_idx")
  @@index([expiresAt], name: "inner_circle_keys_expires_at_idx")
  @@index([revokedAt], name: "inner_circle_keys_revoked_at_idx")
  @@index([keyType], name: "inner_circle_keys_key_type_idx")
}

model ApiRateLimit {
  id           Int      @id @default(autoincrement())
  identifier   String
  bucketType   String
  requestCount Int      @default(0)
  windowStart  DateTime
  windowEnd    DateTime
  lastRequest  DateTime

  @@unique([identifier, bucketType, windowStart], name: "api_rate_limits_identifier_bucket_type_window_start_key")
  @@index([identifier], name: "api_rate_limits_identifier_idx")
  @@index([windowStart], name: "api_rate_limits_window_start_idx")
  @@index([windowEnd], name: "api_rate_limits_window_end_idx")
}

model ContentMetadata {
  id                String   @id @default(cuid())
  slug              String   @unique
  title             String
  contentType       String
  totalDownloads    Int      @default(0)
  uniqueDownloaders Int      @default(0)
  lastDownloadAt    DateTime?
  viewCount         Int      @default(0)
  shareCount        Int      @default(0)
  likeCount         Int      @default(0)
  commentCount      Int      @default(0)
  rating            Float?   @default(0.0)
  tags              String?
  metadata          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now())

  @@index([contentType], name: "content_metadata_content_type_idx")
  @@index([createdAt], name: "content_metadata_created_at_idx")
}

model SystemAuditLog {
  id           String   @id @default(cuid())
  actorType    String
  actorId      String?
  actorEmail   String?
  ipAddress    String?
  action       String
  resourceType String
  resourceId   String?
  oldValue     String?
  newValue     String?
  userAgent    String?
  requestId    String?
  sessionId    String?
  status       String   @default("success")
  severity     String?  @default("low")
  errorMessage String?
  durationMs   Int?
  metadata     String?
  category     String?
  subCategory  String?
  tags         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now())

  @@index([actorType], name: "system_audit_logs_actor_type_idx")
  @@index([actorId], name: "system_audit_logs_actor_id_idx")
  @@index([actorEmail], name: "system_audit_logs_actor_email_idx")
  @@index([action], name: "system_audit_logs_action_idx")
  @@index([resourceType], name: "system_audit_logs_resource_type_idx")
  @@index([resourceId], name: "system_audit_logs_resource_id_idx")
  @@index([status], name: "system_audit_logs_status_idx")
  @@index([severity], name: "system_audit_logs_severity_idx")
  @@index([createdAt], name: "system_audit_logs_created_at_idx")
  @@index([category], name: "system_audit_logs_category_idx")
  @@index([actorType, createdAt], name: "system_audit_logs_actor_type_created_at_idx")
  @@index([resourceType, createdAt], name: "system_audit_logs_resource_type_created_at_idx")
  @@index([status, severity], name: "system_audit_logs_status_severity_idx")
}

model Session {
  id           String   @id @default(cuid())
  sessionId    String   @unique
  memberId     String?
  emailHash    String?
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  lastActivity DateTime
  data         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now())

  member       InnerCircleMember? @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([sessionId], name: "sessions_session_id_idx")
  @@index([memberId], name: "sessions_member_id_idx")
  @@index([emailHash], name: "sessions_email_hash_idx")
  @@index([expiresAt], name: "sessions_expires_at_idx")
}

model CacheEntry {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  expiresAt DateTime
  tags      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@index([key], name: "cache_entries_key_idx")
  @@index([expiresAt], name: "cache_entries_expires_at_idx")
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  type        String   @default("string")
  category    String?  @default("general")
  description String?
  isPublic    Boolean  @default(false)
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@index([key], name: "system_configs_key_idx")
  @@index([category], name: "system_configs_category_idx")
}

model FailedJob {
  id         String   @id @default(cuid())
  queue      String
  payload    String
  error      String
  failedAt   DateTime @default(now())
  retryCount Int      @default(0)
  nextRetry  DateTime?
  createdAt  DateTime @default(now())

  @@index([queue], name: "failed_jobs_queue_idx")
  @@index([failedAt], name: "failed_jobs_failed_at_idx")
  @@index([nextRetry], name: "failed_jobs_next_retry_idx")
}

model MaintenanceLog {
  id          String   @id @default(cuid())
  operation   String
  status      String   @default("pending")
  startedAt   DateTime
  completedAt DateTime?
  durationMs  Int?
  logs        String?
  error       String?
  metadata    String?
  createdBy   String?
  createdAt   DateTime @default(now())

  @@index([operation], name: "maintenance_logs_operation_idx")
  @@index([status], name: "maintenance_logs_status_idx")
  @@index([startedAt], name: "maintenance_logs_started_at_idx")
}

model AdminUser {
  id                  String       @id @default(cuid())
  username            String       @unique
  passwordHash        String
  role                String       @default("admin") // admin, superadmin, editor
  permissions         String       @default("[]") // JSON array of permissions
  mfaEnabled          Boolean      @default(false)
  mfaSecret           String?
  mfaBackupCodes      String?      @default("[]") // JSON array
  status              String       @default("active") // active, locked, suspended
  lastLoginAt         DateTime?
  lastFailedLoginAt   DateTime?
  failedLoginAttempts Int          @default(0)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  sessions            AdminSession[]
  auditLogs           SystemAuditLog[]

  @@index([role], name: "admin_users_role_idx")
  @@index([status], name: "admin_users_status_idx")
  @@index([createdAt], name: "admin_users_created_at_idx")
}

model AdminSession {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  csrfToken    String
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  lastActivity DateTime @default(now())
  data         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], name: "admin_sessions_user_id_idx")
  @@index([token], name: "admin_sessions_token_idx")
  @@index([expiresAt], name: "admin_sessions_expires_at_idx")
}

model SecurityLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  details   String?
  ipAddress String?
  userAgent String?
  severity  String?  @default("LOW") // LOW, MEDIUM, HIGH, CRITICAL
  createdAt DateTime @default(now())

  @@index([userId], name: "security_logs_user_id_idx")
  @@index([action], name: "security_logs_action_idx")
  @@index([severity], name: "security_logs_severity_idx")
  @@index([createdAt], name: "security_logs_created_at_idx")
}

model MfaSetup {
  id              String   @id @default(cuid())
  userId          String   @unique
  methods         String   @default("[]") // JSON array of MfaMethod
  totpSecret      String?
  totpVerified    Boolean  @default(false)
  backupCodes     String   @default("[]") // JSON array
  phoneNumber     String?
  phoneVerified   Boolean  @default(false)
  emailVerified   Boolean  @default(false)
  recoveryEmail   String?
  lastUsedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId], name: "mfa_setups_user_id_idx")
}
// prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"] // Required for pgvector
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")] // Enables semantic discovery
}

// ============================================================================
// 1. CORE IDENTITY & MEMBERSHIP
// ============================================================================

model InnerCircleMember {
  id              String   @id @default(cuid())

  // Identity
  emailHash       String   @unique
  email           String?  @unique
  name            String?

  // Role & Status
  role            String   @default("MEMBER")   // ADMIN | PRINCIPAL | DELEGATE | MEMBER
  tier            String   @default("standard") // standard | elite | private
  status          String   @default("active")

  // Institutional Intelligence
  annotations     PrivateAnnotation[]
  inquiries       StrategyInquiry[]

  // Activity Tracking
  viewCount       Int      @default(0)
  lastSeenAt      DateTime @default(now())
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  downloadEvents  DownloadAuditEvent[]
  sessions        Session[]
  keys            InnerCircleKey[]

  @@index([status])
  @@index([tier])
}

// ============================================================================
// 2. INTELLIGENCE & SEMANTIC SEARCH
// ============================================================================

model ContentMetadata {
  id              String   @id @default(cuid())
  slug            String   @unique
  title           String
  contentType     String   // "Dossier", "Briefing", "Operational_Framework"
  classification  String   @default("RESTRICTED") // PUBLIC, PRIVATE, RESTRICTED
  
  // Content Core
  summary         String?  @db.Text 
  content         String?  @db.Text
  
  // Vector Embedding for Semantic Search (Requires pgvector)
  embedding       Unsupported("vector(1536)")? 

  // Strategic Metrics
  totalPrints     Int      @default(0)
  engagementScore Float    @default(0.0)

  // Relations
  annotations     PrivateAnnotation[]
  dependencies    StrategicLink[]      @relation("SourceBrief")
  dependents      StrategicLink[]      @relation("TargetBrief")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
  @@index([classification])
}

model StrategicLink {
  id              String   @id @default(cuid())
  sourceId        String
  targetId        String
  strength        Float    @default(1.0)
  linkType        String   @default("DEPENDENCY") // PREREQUISITE | COMPLEMENTARY

  sourceBrief     ContentMetadata @relation("SourceBrief", fields: [sourceId], references: [id])
  targetBrief     ContentMetadata @relation("TargetBrief", fields: [targetId], references: [id])

  @@unique([sourceId, targetId])
}

// ============================================================================
// 3. PRIVATE ANNOTATIONS (Commander's Intent)
// ============================================================================

model PrivateAnnotation {
  id              String   @id @default(cuid())
  body            String   @db.Text
  priority        String   @default("ROUTINE") // ROUTINE | URGENT | MANDATE
  
  memberId        String
  member          InnerCircleMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  contentId       String
  content         ContentMetadata   @relation(fields: [contentId], references: [id], onDelete: Cascade)

  embedding       Unsupported("vector(1536)")? // Allows searching personal notes

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([memberId])
  @@index([contentId])
}

// ============================================================================
// 4. STRATEGY INTAKE REGISTRY
// ============================================================================

model StrategyInquiry {
  id              String   @id @default(cuid())
  name            String
  email           String   
  intent          String   @db.Text
  status          String   @default("PENDING") 
  
  metadata        Json?    
  
  memberId        String?
  member          InnerCircleMember? @relation(fields: [memberId], references: [id])

  createdAt       DateTime @default(now())

  // Correct Index Placement
  @@index([email])
  @@index([status])
}

// ============================================================================
// 5. INFRASTRUCTURE & AUDIT
// ============================================================================

model SystemAuditLog {
  id              String   @id @default(cuid())
  action          String   // e.g., "BOARD_MEMO_PRINT"
  severity        String   @default("info") // info | warning | high | critical
  
  actorId         String?
  resourceId      String?
  
  ipAddress       String?
  userAgent       String?
  metadata        Json?

  createdAt       DateTime @default(now())

  @@index([action])
  @@index([severity])
  @@index([actorId])
}

// Keep existing Session, InnerCircleKey, and DownloadAuditEvent logic...
model Session {
  id           String   @id @default(cuid())
  sessionId    String   @unique
  memberId     String?
  expiresAt    DateTime
  member       InnerCircleMember? @relation(fields: [memberId], references: [id], onDelete: Cascade)
}

model InnerCircleKey {
  id           String   @id @default(cuid())
  memberId     String
  keyHash      String   @unique
  status       String   @default("active")
  member       InnerCircleMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
}

model DownloadAuditEvent {
  id           String   @id @default(cuid())
  slug         String
  memberId     String?
  member       InnerCircleMember? @relation(fields: [memberId], references: [id], onDelete: SetNull)
  createdAt    DateTime @default(now())
}
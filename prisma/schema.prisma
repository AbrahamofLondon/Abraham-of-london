/* prisma/schema.prisma */
// ENTERPRISE-GRADE (SQLite-compatible for local dev, Neon-compatible for prod)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // Toggle to "postgresql" for Neon production
  url      = env("DATABASE_URL")
}

// ==================== AUDIT & ANALYTICS MODELS ====================

model DownloadAuditEvent {
  id          String   @id @default(cuid())
  slug        String
  contentType String   @default("download")
  eventType   String   @default("download")
  memberId    String?  @map("member_id")
  member      InnerCircleMember? @relation(fields: [memberId], references: [id], onDelete: SetNull)
  fileName    String?  @map("file_name")
  fileSize    BigInt?  @map("file_size")
  fileHash    String?  @map("file_hash") 
  userId      String?  @map("user_id")
  email       String?
  emailHash   String?  @map("email_hash") 
  sessionId   String?  @map("session_id")
  deviceId    String?  @map("device_id")
  userAgent   String?  @map("user_agent")
  ipAddress   String?  @map("ip_address")
  ipHash      String?  @map("ip_hash")
  countryCode String?  @map("country_code")
  region      String?
  city        String?
  referrer    String?
  utmSource   String?  @map("utm_source")
  utmMedium   String?  @map("utm_medium")
  utmCampaign String?  @map("utm_campaign")
  statusCode  Int?     @map("status_code")
  latencyMs   Int?     @map("latency_ms")
  success     Boolean  @default(true)
  errorCode   String?  @map("error_code")
  errorDetail String?  @map("error_detail")
  createdAt   DateTime @default(now()) @map("created_at")
  processedAt DateTime? @map("processed_at")

  @@index([slug])
  @@index([createdAt])
  @@map("download_audit_events")
}

model ShortInteraction {
  id         Int      @id @default(autoincrement())
  shortSlug  String   @map("short_slug")
  sessionId  String?  @map("session_id")
  emailHash  String?  @map("email_hash")
  memberId   String?  @map("member_id")
  member     InnerCircleMember? @relation(fields: [memberId], references: [id], onDelete: SetNull)
  action     String  
  subAction  String?  @map("sub_action")
  metadata   String?  // JSON string
  userAgent  String?  @map("user_agent")
  ipAddress  String?  @map("ip_address")
  ipHash     String?  @map("ip_hash")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")
  deletedAt  DateTime? @map("deleted_at")

  @@index([shortSlug])
  @@map("short_interactions")
}

model StrategyRoomIntake {
  id                String   @id @default(cuid())
  fullName          String   @map("full_name")
  emailHash         String   @map("email_hash")
  organisation      String
  status            String   
  score             Int
  decisionStatement String   @map("decision_statement")
  payload           String   
  createdAt         DateTime @default(now()) @map("created_at")

  @@index([status])
  @@map("strategy_room_intakes")
}

// ==================== CORE MEMBERSHIP MODELS ====================

model InnerCircleMember {
  id              String   @id @default(uuid())
  emailHash       String   @unique @map("email_hash")
  emailHashPrefix String   @map("email_hash_prefix")
  name            String?
  status          String   @default("active")
  tier            String   @default("standard")
  createdAt       DateTime @default(now()) @map("created_at")
  lastSeenAt      DateTime @default(now()) @map("last_seen_at")
  lastIp          String?  @map("last_ip")
  loginCount      Int      @default(0) @map("login_count")

  keys            InnerCircleKey[]
  auditEvents     DownloadAuditEvent[]
  interactions    ShortInteraction[]

  @@index([status])
  @@map("inner_circle_members")
}

model InnerCircleKey {
  id           String    @id @default(uuid())
  memberId     String    @map("member_id")
  member       InnerCircleMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  keyHash      String    @unique @map("key_hash")
  keySuffix    String    @map("key_suffix")
  status       String    @default("active")
  totalUnlocks Int       @default(0) @map("total_unlocks")
  createdAt    DateTime  @default(now()) @map("created_at")
  lastUsedAt   DateTime? @map("last_used_at")
  lastIp       String?   @map("last_ip")

  @@index([memberId])
  @@map("inner_circle_keys")
}

// ==================== SUPPORTING MODELS ====================

model ApiRateLimit {
  id           Int      @id @default(autoincrement())
  identifier   String
  bucketType   String   @map("bucket_type")
  requestCount Int      @default(0) @map("request_count")
  windowStart  DateTime @map("window_start")
  windowEnd    DateTime @map("window_end")
  lastRequest  DateTime @map("last_request")

  @@unique([identifier, bucketType, windowStart])
  @@map("api_rate_limits")
}

model ContentMetadata {
  id                String    @id @default(cuid())
  slug              String    @unique
  title             String
  contentType       String    @map("content_type")
  totalDownloads    Int       @default(0) @map("total_downloads")
  uniqueDownloaders Int       @default(0) @map("unique_downloaders")
  lastDownloadAt    DateTime? @map("last_download_at")
  viewCount         Int       @default(0) @map("view_count")
  shareCount        Int       @default(0) @map("share_count")
  likeCount         Int       @default(0) @map("like_count")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at")

  @@map("content_metadata")
}

model SystemAuditLog {
  id           String   @id @default(cuid())
  actorType    String   @map("actor_type")
  actorId      String?  @map("actor_id")
  actorEmail   String?  @map("actor_email") // FIXED: Named specifically for audit.ts
  action       String
  resourceType String   @map("resource_type")
  resourceId   String?  @map("resource_id")
  oldValue     String?  @map("old_value")
  newValue     String?  @map("new_value") 
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  requestId    String?  @map("request_id") // FIXED: Matches trace requirements
  status       String   @default("success")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([action])
  @@map("system_audit_logs")
}